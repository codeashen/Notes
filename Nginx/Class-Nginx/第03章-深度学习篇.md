## 3.1 动静分离

通过中间件将动态请求和静态请求分离。

**好处：**分离资源，减少不必要的请求消耗，减少请求延时。

![image-20210105142105753](https://s3.ax1x.com/2021/01/05/skUq58.png)

```
upstream {
	server 127.0.0.1:8080;
}

server {
	listen		80;
	server_name	localhost;
	
	root /opt/app/code;

	location ~ \.jsp$ { 
		proxy_pass http://java_api; 
		index index.htm index.htm;
    }
    
    location ~ \.(jpglpnglgif)$ { 
    	expires 1h； 
    	gzip on； 
    }
    
    location / { 
    	index index.html index.htm;
    }
}

```

## 3.2 Rewrite规则

**rewrite介绍**

Nginx的rewrite可以实现url重写以及重定向，适用场景如下：

* URL访问跳转，支持开发设计

  页面跳转、兼容性支持、展示效果等

* SEO优化

* 维护

  后台维护、流量转发等

* 安全

**配置语法**

```properties
Syntax:		rewrite regex replacement [flag];
Default:	—
Context:	server, location, if
```

如果指定的正则表达式与请求URI匹配，则URI将按照 *replacement* 字符串中的指定进行更改。该 *rewrite* 指令在其在配置文件中出现的顺序顺序地执行。可以使用标志终止指令的进一步处理。如果替换字符串以 *http://*，*https://* 或 *$scheme* 开头，则处理停止，并将重定向返回给客户端。

flag参数：

| flag可选值 | 含义                                                         |
| ---------- | ------------------------------------------------------------ |
| last       | 停止rewrite检测，rewrite后继续匹配location配置，相当于请求转发 |
| break      | 停止rewrite检测，rewrite后不再继续匹配location               |
| redirect   | 返回302临时重定向，地址栏会显示跳转后的地址（后续还是由服务端返回重定向信息） |
| permanent  | 返回301永久重定向，地址栏会显示跳转后的地址（客户端保存重定向信息，不通过服务端直接重定向） |

**Rewrite规则优先级**

1. 执行server块的rewrite指令
2. 执行location匹配
3. 执行选定的location中的rewrite

## 3.3 高级模块

### 3.3.1 secure_link_module模块

该模块用于检查请求的链接，限制未经授权的访问，保护资源。

* 制定并允许检查请求的链接的真实性以及保护资源免遭未经授权的访问
* 限制链接生效周期

**相关配置**

**1、secure_link**

定义一个带有变量的字符串，从中将提取链接的校验和值和过期时间。

```properties
Syntax:		secure_link expression;
Default:	—
Context:	http, server, location
```

**2、secure_link_md5**

定义一个表达式，将为其计算MD5哈希值，并将其与请求中传递的值进行比较。

表达式应包含链接（资源）的安全部分和秘密成分。如果链接的生存期有限，则表达式还应包含*$secure_link_expires*。

```properties
Syntax:		secure_link_md5 expression;
Default:	—
Context:	http, server, location
```

**验证图示：**

![image-20210105160406648](https://s3.ax1x.com/2021/01/05/skUOPS.png)

返回给客户端的下载连接：

![image-20210105160520391](https://s3.ax1x.com/2021/01/05/skUX8g.png)

客户端使用下载连接发起下载请求后，nginx会进行加密验证和过期验证，校验md5参数的加密信息，加密信息可基于IP等信息生成，校验expires指定的过期时间。

**配置示例**

```
location / {
	# 提取链接中的加密串和过期时间
	secure_link $arg_nd5,$arg_expires; 
	# 使用按规则加入字符串"lucifer"进行加密，与上面取到的参数对比，看是否匹配
	secure_link_md5 "$secure_link_expires$uri lucifer";
	
	# 变量$secure_link用于存放验证结果，根据结果执行以下逻辑
	if ($secure_link="") { 
		return 403；
    }
    
    if ($secure_link="0") { 
		return 410；
    }
}
```

### 3.3.2 ngx_http_geoip_module模块

基于IP地址匹配MaxMind GeoIP二进制文件，读取IP所在地域信息。

```shell
# 安装模块
yum install nginx-module-geoip
```

适用场景：

* 区别国内外作HTTP访问规则
* 区别国内城市地域作HTTP访问规则

相关变量

```
$geoip_country_name		国家名
$geoip_country_code		国家代码（CN,US）
$geoip_city				城市名
......
```

配置示例

```
location / {
	# 国家码不是中国就返回403
	if ($geoip_country_code != CN) {
		return 403;
	}
	root /usr/share/nginx/html;
	index index.html index.htm;
}

location /my_ip {
	default_type text/plain; 
	# 输出ip、国家名、国家码、城市名
	return 200 "$remote_addr $geoip_country_name $geoip_country_code $geoip_city";
}
```

## 3.4 基于Nginx的HTTPS服务















































## 3.5 Nginx与Lua开发

Lua是一个简洁、轻量、可扩展的脚本语言。

Nginx+Lua优势：充分的结合Nginx的并发处理epoll优势和Lua的轻量实现简单的功能切高并发的场景。

基础语法

布尔型：只有nil和false是 *false* ；0和空字符串等其他的都是 *true* 

lua变量没有特殊说明的话都是全局变量