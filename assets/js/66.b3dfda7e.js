(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{391:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"一、慢查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、慢查询"}},[s._v("#")]),s._v(" 一、慢查询")]),s._v(" "),t("h2",{attrs:{id:"_1-1-请求的生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-请求的生命周期"}},[s._v("#")]),s._v(" 1.1 请求的生命周期")]),s._v(" "),t("p",[s._v("客户端请求 redis 的一个完整生命周期：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2MLRNn.png",alt:"请求生命周期"}})]),s._v(" "),t("ol",[t("li",[s._v("客户端发送命令")]),s._v(" "),t("li",[s._v("命令到达 redis 中排队（单线程）")]),s._v(" "),t("li",[s._v("执行命令")]),s._v(" "),t("li",[s._v("返回结果到客户端")])]),s._v(" "),t("p",[s._v("关于慢查询的两点说明：")]),s._v(" "),t("ul",[t("li",[s._v("慢查询发生在第 3 阶段")]),s._v(" "),t("li",[s._v("客户端超时不一定慢查询，但慢查询是客户端超时的一个可能因素")])]),s._v(" "),t("h2",{attrs:{id:"_1-2-慢查询配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-慢查询配置"}},[s._v("#")]),s._v(" 1.2 慢查询配置")]),s._v(" "),t("p",[s._v("redis 针对慢查询日志有两个配置，分别为 "),t("code",[s._v("slowlog-max-len")]),s._v(" 和 "),t("code",[s._v("slowlog-log-slower-than")])]),s._v(" "),t("h3",{attrs:{id:"slowlog-max-len"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#slowlog-max-len"}},[s._v("#")]),s._v(" slowlog-max-len")]),s._v(" "),t("p",[t("code",[s._v("slowlog-max-len")]),s._v(" 表示慢查询日志队列的固定长度。慢查询会记录进一个队列，特点如下：")]),s._v(" "),t("ol",[t("li",[s._v("先进先出的队列")]),s._v(" "),t("li",[s._v("队列长度固定")]),s._v(" "),t("li",[t("strong",[s._v("队列保存在内存中")])])]),s._v(" "),t("p",[s._v("如下图左边所示，如果一条命令执行时间超过 10000 微秒（"),t("code",[s._v("slowlog-log-slower-than")]),s._v("），则进入慢查询队列（"),t("code",[s._v("slowlog list")]),s._v("），队列的长度是 100（"),t("code",[s._v("slowlog-max-len")]),s._v("）。图中右边表示 "),t("code",[s._v("slowlog100")]),s._v(" ~ "),t("code",[s._v("slowlog1")]),s._v(" 的慢查询数据。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2MO4IA.png",alt:"慢查询日志记录过程"}})]),s._v(" "),t("h3",{attrs:{id:"slowlog-log-slower-than"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#slowlog-log-slower-than"}},[s._v("#")]),s._v(" slowlog-log-slower-than")]),s._v(" "),t("p",[t("code",[s._v("slowlog-log-slower-than")]),s._v(" 表示慢查询阈值（单位：毫秒），有以下特点：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("slowlog-log-slower-than=0")]),s._v("，记录所有的命令")]),s._v(" "),t("li",[t("code",[s._v("slowlog-log-slower-than<0")]),s._v("，不记录任何命令")])]),s._v(" "),t("h3",{attrs:{id:"配置方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置方式"}},[s._v("#")]),s._v(" 配置方式")]),s._v(" "),t("p",[s._v("获取默认值：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" config get slowlog-max-len\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"slowlog-max-len"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"128"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" config get slowlog-log-slower-than\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"slowlog-log-slower-than"')]),s._v("\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10000"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("配置方式一：修改配置文件，重启 redis")])]),s._v(" "),t("li",[t("p",[s._v("配置方式一：动态配置，无需重启")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" config "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" slowlog-max-len "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" config "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" slowlog-log-slower-than "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"_1-3-慢查询命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-慢查询命令"}},[s._v("#")]),s._v(" 1.3 慢查询命令")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("slowlog get [n]")]),s._v("：获取慢查询队列记录")]),s._v(" "),t("li",[t("code",[s._v("slowlog len")]),s._v("：获取慢查询队列长度")]),s._v(" "),t("li",[t("code",[s._v("slowlog reset")]),s._v("：清空慢查询队列")])]),s._v(" "),t("h2",{attrs:{id:"_1-4-运维经验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-运维经验"}},[s._v("#")]),s._v(" 1.4 运维经验")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("slowlog-log-slower-then")]),s._v(" 不要设置过大，默认 10ms，通常设置 1ms")]),s._v(" "),t("li",[t("code",[s._v("slowlog-max-len")]),s._v(" 不要设置过小，通常设置 1000 左右")]),s._v(" "),t("li",[s._v("理解命令生命周期")]),s._v(" "),t("li",[s._v("定期持久化慢查询日志（存在内存中的，持久化方便后续分析）")])]),s._v(" "),t("h1",{attrs:{id:"二、pipeline-流水线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、pipeline-流水线"}},[s._v("#")]),s._v(" 二、pipeline 流水线")]),s._v(" "),t("h2",{attrs:{id:"_2-1-什么是流水线"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-什么是流水线"}},[s._v("#")]),s._v(" 2.1 什么是流水线")]),s._v(" "),t("p",[s._v("1 次网络命令通信模型")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2QMlCR.png",alt:"1次网络命令通信模型"}})]),s._v(" "),t("p",[s._v("批量网络命令通信模型")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2QM7rT.png",alt:"批量网络命令通信模型"}})]),s._v(" "),t("p",[s._v("流水线命令网络模型")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2QQBo4.png",alt:"流水线命令网络模型"}})]),s._v(" "),t("h2",{attrs:{id:"_2-2-流水线的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-流水线的作用"}},[s._v("#")]),s._v(" 2.2 流水线的作用")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("命令")]),s._v(" "),t("th",[s._v("n 个命令操作")]),s._v(" "),t("th",[s._v("1 次 pipeline（n 个命令）")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("时间")]),s._v(" "),t("td",[s._v("n 次网络 + n 次命令")]),s._v(" "),t("td",[s._v("1 次网络 + n 次命令")])]),s._v(" "),t("tr",[t("td",[s._v("数据量")]),s._v(" "),t("td",[s._v("1 条命令")]),s._v(" "),t("td",[s._v("n 条命令")])])])]),s._v(" "),t("p",[s._v("注意两点：")]),s._v(" "),t("ol",[t("li",[s._v("redis 执行命令通常是微秒级别的")]),s._v(" "),t("li",[s._v("pipeline 每次条数要控制（网络）")])]),s._v(" "),t("h2",{attrs:{id:"_2-3-java-中使用-pipeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-java-中使用-pipeline"}},[s._v("#")]),s._v(" 2.3 Java 中使用 pipeline")]),s._v(" "),t("p",[s._v("引入依赖")]),s._v(" "),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("redis.clients"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jedis"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("2.9.0"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jar"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("scope")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("compile"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("scope")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("场景：执行 10000 次 hset 操作，生成 10000 个哈希。（不能使用 hmset，hmset 是生成一个 hash，里面 n 个 field-value 对）")]),s._v(" "),t("p",[s._v("不使用 pipeline 的情况，10000 次网络 + 10000 次命令，要 50s")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ======== 不使用 pipeline ========")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    jedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hashkey:"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"field"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("使用 pipeline，分 100 次，每次携带 100 条命令，100 次网络 + 10000 次命令，要 0.7s")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ======== 使用 pipeline ========")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 分 100 次 pipeline 操作")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Pipeline")]),s._v(" pipeline "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedis"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("pipelined")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" j "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" j "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" j"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 每次携带命令数量 100")]),s._v("\n        pipeline"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hashkey:"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"field"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行携带了 100 条命令的 pipeline")]),s._v("\n    pipeline"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("syncAndReturnAll")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h2",{attrs:{id:"_2-4-pipeline-和批量操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-pipeline-和批量操作"}},[s._v("#")]),s._v(" 2.4 pipeline 和批量操作")]),s._v(" "),t("p",[s._v("m 操作（批量操作）是一条命令，是原子的")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2QGEvR.png",alt:"image-20210602155250161"}})]),s._v(" "),t("p",[s._v("pipeline 操作到达 redis 会被拆分，是非原子的")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2QG8xA.png",alt:"image-20210602155409475"}})]),s._v(" "),t("h2",{attrs:{id:"_2-5-pipeline-注意事项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-pipeline-注意事项"}},[s._v("#")]),s._v(" 2.5 pipeline 注意事项")]),s._v(" "),t("ol",[t("li",[s._v("注意每次 pipeline 携带数据量")]),s._v(" "),t("li",[s._v("pipeline 每次只能作用在一个 Redis 节点上")]),s._v(" "),t("li",[s._v("注意 M 操作与 pipeline 区别")])]),s._v(" "),t("h1",{attrs:{id:"三、发布订阅"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、发布订阅"}},[s._v("#")]),s._v(" 三、发布订阅")]),s._v(" "),t("h2",{attrs:{id:"_2-1-发布订阅模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-发布订阅模式"}},[s._v("#")]),s._v(" 2.1 发布订阅模式")]),s._v(" "),t("p",[s._v("redis 发布订阅模式中有以下角色")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("发布者（publisher）")]),s._v("：发布消息频道")]),s._v(" "),t("li",[t("strong",[s._v("订阅者（subscriber）")]),s._v("：订阅频道")]),s._v(" "),t("li",[t("strong",[s._v("频道（channel）")]),s._v("：接收发布者的消息分发给订阅者")])]),s._v(" "),t("p",[s._v("发布订阅消息模型：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2Qwb5t.png",alt:"image-20210602162428427"}})]),s._v(" "),t("ul",[t("li",[s._v("发布者发布消息到频道 A，订阅频道 A 的所有订阅者都能收到消息")]),s._v(" "),t("li",[s._v("redis 发布订阅模式没有消息堆积能力，订阅者只能收到订阅之后发出的消息。")])]),s._v(" "),t("h2",{attrs:{id:"_2-2-发布订阅api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-发布订阅api"}},[s._v("#")]),s._v(" 2.2 发布订阅API")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("publish channel message")]),s._v("：发布消息到频道，返回订阅者个数")]),s._v(" "),t("li",[t("code",[s._v("subscribe [channel]")]),s._v("：订阅一个或多个频道，会收到消息和对应的频道")]),s._v(" "),t("li",[t("code",[s._v("unsubscribe [channel]")]),s._v("：取消订阅一个或多个频道")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ===== 发布消息 =====")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" publish sohu:tv "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 订阅者个数 ")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" publish sohu:auto "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"taxi"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ===== 订阅消息 =====")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" subscribe sohu:tv \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subscribe"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sohu:tv"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sohu:tv"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ===== 取消订阅 =====")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" unsubscribe sohu:tv \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"unsubscribe"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sohu:tv"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[s._v("其他 API")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" psubscribe "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pattern"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 订阅模式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" punsubscribe "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pattern"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退订指定的模式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pubsub channels              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出至少有一个订阅者的频道")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pubsub numsub "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("channel"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出给定频道的订阅者数量")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pubsub numpat                "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出被订阅模式的数量")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h1",{attrs:{id:"四、bitmap"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、bitmap"}},[s._v("#")]),s._v(" 四、Bitmap")]),s._v(" "),t("h2",{attrs:{id:"_4-1-bitmap-位图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-bitmap-位图"}},[s._v("#")]),s._v(" 4.1 Bitmap 位图")]),s._v(" "),t("p",[t("strong",[s._v("Bitmap 实际是字符串的二进制表示形式。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2Q4Q2Q.png",alt:"image-20210602173612008"}})]),s._v(" "),t("p",[s._v('图中字符串 "big" 中字符 \'b\' 的 ASCII 码是 98，应对的二进制数是 01100010，其他字符同理，就得到了 "big" 的二进制表示。')]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" hello big    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置字符串，key: hello，value: big")]),s._v("\nOK\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" getbit hello "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取 hello 值的第 0 位")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" getbit hello "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取 hello 值的第 1 位")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v('上述命令，操作的就是字符串 "big" 对应的二进制。即在 redis 中，是可以直接操作位的。')]),s._v(" "),t("h2",{attrs:{id:"_4-2-位图-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-位图-api"}},[s._v("#")]),s._v(" 4.2 位图 API")]),s._v(" "),t("p",[t("strong",[s._v("命令一：setbit")])]),s._v(" "),t("p",[t("code",[s._v("setbit key offset value")]),s._v("：给位图指定索引设置值")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" setbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[t("strong",[s._v("设置的 offset 超过原来位图长度，会直接自动拉长，中间补零 0")]),s._v("，如下图所示")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/06/02/2Q576J.png",alt:"image-20210602174332130"}})]),s._v(" "),t("p",[t("strong",[s._v("命令二：getbit")])]),s._v(" "),t("p",[t("code",[s._v("getbit key offset")]),s._v("：获取位图指定索引的值")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" getbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" getbit unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("命令三：bitcount")])]),s._v(" "),t("p",[t("code",[s._v("bitcount key [start end]")]),s._v("：获取位图指定范围位值为 1 的个数 （start 到 end，单位为字节，如果不指定就是获取全部）")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitcount unique:users:2016-04-05 \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitcount unique:users:2016-04-05 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("命令四：bitop")])]),s._v(" "),t("p",[t("code",[s._v("bitop op destkey key [key...]")]),s._v("： 做多个 Bitmap 的 and(交集）、or（并集）、not（非）、xor（异或） 操作并将结果保存在 destkey 中")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 并求两个位图的并集 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitop and unique:users:and:2016_0404-2016_04_05 unique:users:2016-04-05 unique:users:2016-04-04 \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitcount unique:users:and:2016_0404-2016_04_05 \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("strong",[s._v("命令五：bitpos")])]),s._v(" "),t("p",[t("code",[s._v("bitpos key targetBit [start] [end]")]),s._v("： 计算位图指定范围第一个偏移量对应的值等于 targetBit 的位置 （start 到 end，单位为字节，如果不指定就是获取全部）")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 类似于 indexOf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitpos unique:users:2016-04-04 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bitpos unique:users:2016-04-04 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"_4-3-独立用户统计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-独立用户统计"}},[s._v("#")]),s._v(" 4.3 独立用户统计")]),s._v(" "),t("p",[s._v("场景：某网站有 n 个用户，现需要记录每天访问的独立用户")]),s._v(" "),t("p",[s._v("假设有一亿用户，5 千不同用户访问。要存储这一亿用户 id 中的 5 千万条，有以下方案：")]),s._v(" "),t("ul",[t("li",[s._v("set：将用户 id 存到 set 中去")]),s._v(" "),t("li",[s._v("bitmap：bitmap 中每一位代表一个用户，先将所有的用户置 0，然后 1 代表用户访问了。")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("数据类型")]),s._v(" "),t("th",[s._v("每个 userId 占用空间")]),s._v(" "),t("th",[s._v("要存储的用户量")]),s._v(" "),t("th",[s._v("所需内存")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("set")]),s._v(" "),t("td",[s._v("32位（假设整型）")]),s._v(" "),t("td",[s._v("50,000,000")]),s._v(" "),t("td",[s._v("32位 * 50,000,000 = 200MB")])]),s._v(" "),t("tr",[t("td",[s._v("bitmap")]),s._v(" "),t("td",[s._v("1位")]),s._v(" "),t("td",[s._v("100,000,000")]),s._v(" "),t("td",[s._v("1位 * 100,000,000 = 12.5MB")])])])]),s._v(" "),t("p",[s._v("长期使用所需内存：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("数据类型")]),s._v(" "),t("th",[s._v("一天")]),s._v(" "),t("th",[s._v("一月")]),s._v(" "),t("th",[s._v("一年")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("set")]),s._v(" "),t("td",[s._v("200MB")]),s._v(" "),t("td",[s._v("6G")]),s._v(" "),t("td",[s._v("72G")])]),s._v(" "),t("tr",[t("td",[s._v("bitmap")]),s._v(" "),t("td",[s._v("12.5MB")]),s._v(" "),t("td",[s._v("375MB")]),s._v(" "),t("td",[s._v("4.5G")])])])]),s._v(" "),t("p",[s._v("如果是只有 10 万用户访问，那么：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("数据类型")]),s._v(" "),t("th",[s._v("每个 userId 占用空间")]),s._v(" "),t("th",[s._v("要存储的用户量")]),s._v(" "),t("th",[s._v("所需内存")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("set")]),s._v(" "),t("td",[s._v("32位（假设整型）")]),s._v(" "),t("td",[s._v("100,000")]),s._v(" "),t("td",[s._v("32位 * 100,000 = 4MB")])]),s._v(" "),t("tr",[t("td",[s._v("bitmap")]),s._v(" "),t("td",[s._v("1位")]),s._v(" "),t("td",[s._v("100,000,000")]),s._v(" "),t("td",[s._v("1位 * 100,000,000 = 12.5MB")])])])]),s._v(" "),t("p",[s._v("此时使用 set 更节省空间。")]),s._v(" "),t("h2",{attrs:{id:"_4-4-bitmap-使用经验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-bitmap-使用经验"}},[s._v("#")]),s._v(" 4.4 Bitmap 使用经验")]),s._v(" "),t("ol",[t("li",[s._v("Bitmap 实际就是字符串，最大存储 512MB")]),s._v(" "),t("li",[s._v("注意 setbit 时的偏移量，可能有较大耗时")]),s._v(" "),t("li",[s._v("位图不是绝对好")])]),s._v(" "),t("h1",{attrs:{id:"五、hyperloglog"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五、hyperloglog"}},[s._v("#")]),s._v(" 五、HyperLoglog")]),s._v(" "),t("h2",{attrs:{id:"_5-1-hyperloglog-介绍和使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-hyperloglog-介绍和使用"}},[s._v("#")]),s._v(" 5.1 HyperLoglog 介绍和使用")]),s._v(" "),t("p",[s._v("HyperLoglog 介绍")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("基于 HyperLoglog 算法：极小空间完成独立数据统计")])]),s._v(" "),t("li",[t("p",[s._v("本质还是字符串")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" hyperloglog_key\nstring\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])])])]),s._v(" "),t("p",[s._v("三个相关命令")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("pfadd key element [element...]")]),s._v("：向 hyperloglog 添加元素")]),s._v(" "),t("li",[t("code",[s._v("pfcount key [key...]")]),s._v("：计算 hyperloglog 的独立总数")]),s._v(" "),t("li",[t("code",[s._v("pfmerge destkey sourcekey [sourcekey...]")]),s._v("：合并多个 hyperloglog")])]),s._v(" "),t("p",[s._v("使用演示")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 操作3月5日的用户数据")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfadd 2017_03_06:unique:ids "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-2"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-3"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-4"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfcount 2017_03_06:unique:ids \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" \nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfadd 2017_03_06:unique:ids "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-2"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-3"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-90"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfcount 2017_03_06:unique:ids \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 操作3月6日的用户数据")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfadd 2016_03_06:unique:ids "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-2"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-3"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uuid-8"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfcount 2016_03_06:unique:ids \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 合并数据")]),s._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfmerge 2016_03_05_06:unique:ids 2016_03_05:unique:ids 2016_03_06:unique:ids\nOK\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pfcount 2016_03_05_06:unique:ids\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("h2",{attrs:{id:"_5-2-使用经验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-使用经验"}},[s._v("#")]),s._v(" 5.2 使用经验")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# shell 脚本表，向 HyperLoglog 中插入百万数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elements")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("key")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2016_05_01:unique:ids"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("i")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 'seq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v("`\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elements")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${elements}")]),s._v(' uuid-"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${i}")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$((")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("))")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" \n    \tredis-cli pfadd "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${key}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${elements}")]),s._v(" \n    \t"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("elements")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("上述脚本插入百万数据后，HyperLoglog 仅仅占用 15KB 内存。")]),s._v(" "),t("p",[s._v("使用 HyperLoglog 的局限：")]),s._v(" "),t("ol",[t("li",[s._v("是否能容忍错误？（错误率：0.81%）")]),s._v(" "),t("li",[s._v("是否需要单条数据？（不能取出单条数据）")])]),s._v(" "),t("h1",{attrs:{id:"六、geo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#六、geo"}},[s._v("#")]),s._v(" 六、GEO")]),s._v(" "),t("p",[s._v("GEO（地理信息定位）：存储经纬度，计算两地距离，范围计算等")]),s._v(" "),t("h2",{attrs:{id:"_6-1-geo-的-api"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-geo-的-api"}},[s._v("#")]),s._v(" 6.1 GEO 的 API")]),s._v(" "),t("p",[t("strong",[s._v("geoadd")])]),s._v(" "),t("p",[t("code",[s._v("geoadd key longitude latitude member [longitude latitude member...]")]),s._v(" ：增加地理位置信息")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" geoadd cities:locations "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("116.28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.55")]),s._v(" beijing \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" geoadd cities:locations "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("116.28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.55")]),s._v(" beijing \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" geoadd cities:locations "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("117.12")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39.08")]),s._v(" tianjin "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("114.29")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38.02")]),s._v(" shijiazhuang "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("118.0139")]),s._v(".38 tangshan "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("115.29")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38.51")]),s._v(" baoding \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("integer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[t("strong",[s._v("geopos")])]),s._v(" "),t("p",[t("code",[s._v("geopos key member [member...]")]),s._v("：获取地理位置信息")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" geopos cities:locations tianjin \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"117.12000042200088501"')]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"39.0800000535766543"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("geodist")])]),s._v(" "),t("p",[t("code",[s._v("geodist key member1 member2 [unit]")]),s._v("： 获取两个地理位置的距离，unit：m（米）、km（干米）、mi（英里）、ft（尺）")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" geodist cities:locations tianjin beijing km \n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"89.2061"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("georadius")])]),s._v(" "),t("p",[s._v("georadius 以给定的经纬度为中心，返回键包含的位置元素当中，与中心的距离不超过给定最大距离的所有位置元素。")]),s._v(" "),t("p",[s._v("API介绍：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",[t("code",[s._v("georadius key longitude latitude radiusm|km|ft|mi [withcoord] [withdist] [withhash] [COUNT count][asc|desc] [store key] [storedist key] \n\ngeoradiusbymember key member radiusm|km|ft|mi [withcoord] [withdist] [withhash] [COUNT count] [asc|desc] [store key] [storedist key] \n\nwithcoord:     返回结果中包含经纬度。\nwithdist:      返回结果中包含距离中心节点位置。\nwithhash:      返回结果中包含 geohash COUNT count: 指定返回结果的数量。\nascldesc:      返回结果按照距离中心节点的距离做升序或者降序。\nstore key:     将返回结果的地理位置信息保存到指定键。\nstoredist key: 将返回结果距离中心节点的距离保存到指定键s\n")])])]),t("p",[s._v("使用示例：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" georadiusbymember cities:locations beijing "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("150")]),s._v(" km \n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"beijing"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tianjin"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tangshan"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"baoding"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"_6-2-使用说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-使用说明"}},[s._v("#")]),s._v(" 6.2 使用说明")]),s._v(" "),t("ol",[t("li",[s._v("since 3.2+")]),s._v(" "),t("li",[s._v("geo 是使用 zset 实现的，type geokey = zset")]),s._v(" "),t("li",[s._v("没有删除 API，使用 zset 方式删除："),t("code",[s._v("zrem key member")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);