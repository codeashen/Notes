<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第02章-场景实践篇 | CodeAshen&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="后端技术博客,专注后端技术学习与总结。Java,Python,JavaScript,TypeScript,Spring,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,后端面试题,技术文档,学习,面试,Java,Python,JavaScript,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9c8cf8c.css" as="style"><link rel="preload" href="/assets/js/app.973ec296.js" as="script"><link rel="preload" href="/assets/js/2.6aaa6d1e.js" as="script"><link rel="preload" href="/assets/js/43.4e6aa9e5.js" as="script"><link rel="prefetch" href="/assets/js/10.c128a7de.js"><link rel="prefetch" href="/assets/js/100.c5332952.js"><link rel="prefetch" href="/assets/js/101.472590ad.js"><link rel="prefetch" href="/assets/js/102.f697d18e.js"><link rel="prefetch" href="/assets/js/103.d8218fae.js"><link rel="prefetch" href="/assets/js/104.8851b38a.js"><link rel="prefetch" href="/assets/js/105.e9164174.js"><link rel="prefetch" href="/assets/js/106.fb403dea.js"><link rel="prefetch" href="/assets/js/107.ea7dbfb9.js"><link rel="prefetch" href="/assets/js/108.841273d4.js"><link rel="prefetch" href="/assets/js/109.a01a78fe.js"><link rel="prefetch" href="/assets/js/11.8d1708c7.js"><link rel="prefetch" href="/assets/js/110.8f5d172e.js"><link rel="prefetch" href="/assets/js/111.524e2bcf.js"><link rel="prefetch" href="/assets/js/112.b8a747e9.js"><link rel="prefetch" href="/assets/js/113.a9b1b9a0.js"><link rel="prefetch" href="/assets/js/114.7e4041d8.js"><link rel="prefetch" href="/assets/js/115.e2882f73.js"><link rel="prefetch" href="/assets/js/116.1d415864.js"><link rel="prefetch" href="/assets/js/117.71e63524.js"><link rel="prefetch" href="/assets/js/118.8986f793.js"><link rel="prefetch" href="/assets/js/119.80bcd61e.js"><link rel="prefetch" href="/assets/js/12.0132831e.js"><link rel="prefetch" href="/assets/js/120.dc2754a6.js"><link rel="prefetch" href="/assets/js/121.1dbe4441.js"><link rel="prefetch" href="/assets/js/122.446eb0a0.js"><link rel="prefetch" href="/assets/js/123.bac389f3.js"><link rel="prefetch" href="/assets/js/124.c087aa83.js"><link rel="prefetch" href="/assets/js/125.dcec8498.js"><link rel="prefetch" href="/assets/js/126.7e932ea3.js"><link rel="prefetch" href="/assets/js/127.2ae0bcd8.js"><link rel="prefetch" href="/assets/js/128.2d4ad1d9.js"><link rel="prefetch" href="/assets/js/129.4d6a08f8.js"><link rel="prefetch" href="/assets/js/13.209ff1e9.js"><link rel="prefetch" href="/assets/js/130.8936ad8a.js"><link rel="prefetch" href="/assets/js/131.11ca372c.js"><link rel="prefetch" href="/assets/js/132.9be75880.js"><link rel="prefetch" href="/assets/js/133.9955d166.js"><link rel="prefetch" href="/assets/js/134.5be1b51a.js"><link rel="prefetch" href="/assets/js/135.d0f8d2e0.js"><link rel="prefetch" href="/assets/js/136.ca304a24.js"><link rel="prefetch" href="/assets/js/137.1a0a904c.js"><link rel="prefetch" href="/assets/js/138.8ab30fee.js"><link rel="prefetch" href="/assets/js/139.cf78c4d4.js"><link rel="prefetch" href="/assets/js/14.d6134190.js"><link rel="prefetch" href="/assets/js/140.6c61677f.js"><link rel="prefetch" href="/assets/js/141.51ef4f6a.js"><link rel="prefetch" href="/assets/js/142.5a2feec0.js"><link rel="prefetch" href="/assets/js/143.f7200d74.js"><link rel="prefetch" href="/assets/js/144.1c36af9b.js"><link rel="prefetch" href="/assets/js/145.2ba88ed7.js"><link rel="prefetch" href="/assets/js/146.7ddd636f.js"><link rel="prefetch" href="/assets/js/147.835c06fe.js"><link rel="prefetch" href="/assets/js/148.5bfc3184.js"><link rel="prefetch" href="/assets/js/149.15658978.js"><link rel="prefetch" href="/assets/js/15.10140158.js"><link rel="prefetch" href="/assets/js/150.f1414565.js"><link rel="prefetch" href="/assets/js/151.6fe4a9f2.js"><link rel="prefetch" href="/assets/js/152.0694636f.js"><link rel="prefetch" href="/assets/js/153.d4a79e2b.js"><link rel="prefetch" href="/assets/js/154.f49c40b1.js"><link rel="prefetch" href="/assets/js/155.11c4af47.js"><link rel="prefetch" href="/assets/js/156.17a27449.js"><link rel="prefetch" href="/assets/js/157.03222e94.js"><link rel="prefetch" href="/assets/js/158.fd10abd2.js"><link rel="prefetch" href="/assets/js/159.7854cf98.js"><link rel="prefetch" href="/assets/js/16.deabf74a.js"><link rel="prefetch" href="/assets/js/160.bcceda6c.js"><link rel="prefetch" href="/assets/js/161.827af027.js"><link rel="prefetch" href="/assets/js/162.855aca43.js"><link rel="prefetch" href="/assets/js/163.72d27148.js"><link rel="prefetch" href="/assets/js/164.3e01c09c.js"><link rel="prefetch" href="/assets/js/165.e652258b.js"><link rel="prefetch" href="/assets/js/166.ecaa4581.js"><link rel="prefetch" href="/assets/js/167.e8ff99fa.js"><link rel="prefetch" href="/assets/js/168.02abfd0d.js"><link rel="prefetch" href="/assets/js/169.8fbd2db6.js"><link rel="prefetch" href="/assets/js/17.f69b8f6b.js"><link rel="prefetch" href="/assets/js/170.69e15007.js"><link rel="prefetch" href="/assets/js/171.cf706d56.js"><link rel="prefetch" href="/assets/js/172.3e4c3668.js"><link rel="prefetch" href="/assets/js/173.6ff18f12.js"><link rel="prefetch" href="/assets/js/174.453f4245.js"><link rel="prefetch" href="/assets/js/175.063163ca.js"><link rel="prefetch" href="/assets/js/176.edf6516c.js"><link rel="prefetch" href="/assets/js/177.c6ea414e.js"><link rel="prefetch" href="/assets/js/178.da8150fd.js"><link rel="prefetch" href="/assets/js/179.98958ecb.js"><link rel="prefetch" href="/assets/js/18.1a578fab.js"><link rel="prefetch" href="/assets/js/180.a98d2988.js"><link rel="prefetch" href="/assets/js/181.e7d9677d.js"><link rel="prefetch" href="/assets/js/182.dcae9e42.js"><link rel="prefetch" href="/assets/js/183.aee29579.js"><link rel="prefetch" href="/assets/js/184.98755068.js"><link rel="prefetch" href="/assets/js/185.82f47215.js"><link rel="prefetch" href="/assets/js/186.442d78c2.js"><link rel="prefetch" href="/assets/js/187.b37b3a63.js"><link rel="prefetch" href="/assets/js/188.b2405297.js"><link rel="prefetch" href="/assets/js/189.b3b59e8a.js"><link rel="prefetch" href="/assets/js/19.395617bc.js"><link rel="prefetch" href="/assets/js/190.ca137199.js"><link rel="prefetch" href="/assets/js/191.aa8a7422.js"><link rel="prefetch" href="/assets/js/192.270c2e56.js"><link rel="prefetch" href="/assets/js/193.e9d382d3.js"><link rel="prefetch" href="/assets/js/194.4d804198.js"><link rel="prefetch" href="/assets/js/195.b5b758e9.js"><link rel="prefetch" href="/assets/js/196.81bdc47b.js"><link rel="prefetch" href="/assets/js/197.3dd5c487.js"><link rel="prefetch" href="/assets/js/198.49c5c5e0.js"><link rel="prefetch" href="/assets/js/199.e4e9ff5b.js"><link rel="prefetch" href="/assets/js/20.af9c51b5.js"><link rel="prefetch" href="/assets/js/200.137782e2.js"><link rel="prefetch" href="/assets/js/201.cb4e5b2b.js"><link rel="prefetch" href="/assets/js/202.51abb277.js"><link rel="prefetch" href="/assets/js/203.83ed2d8a.js"><link rel="prefetch" href="/assets/js/21.cac71621.js"><link rel="prefetch" href="/assets/js/22.c51a3f6c.js"><link rel="prefetch" href="/assets/js/23.d9987c58.js"><link rel="prefetch" href="/assets/js/24.0b2c6cb2.js"><link rel="prefetch" href="/assets/js/25.c5aaf6b9.js"><link rel="prefetch" href="/assets/js/26.c4307053.js"><link rel="prefetch" href="/assets/js/27.27c8f8d4.js"><link rel="prefetch" href="/assets/js/28.b884b191.js"><link rel="prefetch" href="/assets/js/29.11a7cac3.js"><link rel="prefetch" href="/assets/js/3.52039520.js"><link rel="prefetch" href="/assets/js/30.e0296187.js"><link rel="prefetch" href="/assets/js/31.f612d60e.js"><link rel="prefetch" href="/assets/js/32.da15f932.js"><link rel="prefetch" href="/assets/js/33.06c4feab.js"><link rel="prefetch" href="/assets/js/34.fa726970.js"><link rel="prefetch" href="/assets/js/35.5dfa35dd.js"><link rel="prefetch" href="/assets/js/36.e8ee6c32.js"><link rel="prefetch" href="/assets/js/37.f34d8356.js"><link rel="prefetch" href="/assets/js/38.db8e9d1d.js"><link rel="prefetch" href="/assets/js/39.2d902803.js"><link rel="prefetch" href="/assets/js/4.94dce7a4.js"><link rel="prefetch" href="/assets/js/40.9b2c544f.js"><link rel="prefetch" href="/assets/js/41.bce99484.js"><link rel="prefetch" href="/assets/js/42.a0c6c78b.js"><link rel="prefetch" href="/assets/js/44.ef9352e3.js"><link rel="prefetch" href="/assets/js/45.ae779112.js"><link rel="prefetch" href="/assets/js/46.fb4a183c.js"><link rel="prefetch" href="/assets/js/47.fae1056f.js"><link rel="prefetch" href="/assets/js/48.56b0b378.js"><link rel="prefetch" href="/assets/js/49.a6f88870.js"><link rel="prefetch" href="/assets/js/5.e01aaa8d.js"><link rel="prefetch" href="/assets/js/50.83e82362.js"><link rel="prefetch" href="/assets/js/51.e9419834.js"><link rel="prefetch" href="/assets/js/52.a1967369.js"><link rel="prefetch" href="/assets/js/53.94af57c3.js"><link rel="prefetch" href="/assets/js/54.b50e8783.js"><link rel="prefetch" href="/assets/js/55.8063724b.js"><link rel="prefetch" href="/assets/js/56.76bf8a2a.js"><link rel="prefetch" href="/assets/js/57.f9f3f777.js"><link rel="prefetch" href="/assets/js/58.f5fc8f65.js"><link rel="prefetch" href="/assets/js/59.6d369d87.js"><link rel="prefetch" href="/assets/js/6.07a7065d.js"><link rel="prefetch" href="/assets/js/60.5d94a162.js"><link rel="prefetch" href="/assets/js/61.0ad7c924.js"><link rel="prefetch" href="/assets/js/62.85956477.js"><link rel="prefetch" href="/assets/js/63.7e5be0fc.js"><link rel="prefetch" href="/assets/js/64.fbae5632.js"><link rel="prefetch" href="/assets/js/65.ddcfdbe6.js"><link rel="prefetch" href="/assets/js/66.b3dfda7e.js"><link rel="prefetch" href="/assets/js/67.6ee30a4e.js"><link rel="prefetch" href="/assets/js/68.71e1e060.js"><link rel="prefetch" href="/assets/js/69.4ed5537a.js"><link rel="prefetch" href="/assets/js/7.7a33a5a5.js"><link rel="prefetch" href="/assets/js/70.ad84b59a.js"><link rel="prefetch" href="/assets/js/71.136b2322.js"><link rel="prefetch" href="/assets/js/72.49c8fc99.js"><link rel="prefetch" href="/assets/js/73.7b0351b5.js"><link rel="prefetch" href="/assets/js/74.e7a0ce34.js"><link rel="prefetch" href="/assets/js/75.fc40be0c.js"><link rel="prefetch" href="/assets/js/76.bc90d4b8.js"><link rel="prefetch" href="/assets/js/77.0cb653a2.js"><link rel="prefetch" href="/assets/js/78.b692f5f9.js"><link rel="prefetch" href="/assets/js/79.effdc1de.js"><link rel="prefetch" href="/assets/js/8.17467f67.js"><link rel="prefetch" href="/assets/js/80.87603bda.js"><link rel="prefetch" href="/assets/js/81.4c9aac1e.js"><link rel="prefetch" href="/assets/js/82.54ab2e24.js"><link rel="prefetch" href="/assets/js/83.d34317d2.js"><link rel="prefetch" href="/assets/js/84.093a866c.js"><link rel="prefetch" href="/assets/js/85.dfe1b6bc.js"><link rel="prefetch" href="/assets/js/86.ffef04fb.js"><link rel="prefetch" href="/assets/js/87.52805dce.js"><link rel="prefetch" href="/assets/js/88.dd97eda8.js"><link rel="prefetch" href="/assets/js/89.425cc035.js"><link rel="prefetch" href="/assets/js/9.a64e81dc.js"><link rel="prefetch" href="/assets/js/90.3e58b256.js"><link rel="prefetch" href="/assets/js/91.711a6bba.js"><link rel="prefetch" href="/assets/js/92.3cc169cd.js"><link rel="prefetch" href="/assets/js/93.4e7bbb8c.js"><link rel="prefetch" href="/assets/js/94.e5c6ff23.js"><link rel="prefetch" href="/assets/js/95.adc48da9.js"><link rel="prefetch" href="/assets/js/96.84e8c33b.js"><link rel="prefetch" href="/assets/js/97.61e63949.js"><link rel="prefetch" href="/assets/js/98.fc0fb11b.js"><link rel="prefetch" href="/assets/js/99.b473d996.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9c8cf8c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="CodeAshen's blog" class="logo"> <span class="site-name can-hide">CodeAshen's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/32011a/" class="nav-link">《剖析Spring5核心原理》</a></li><li class="dropdown-subitem"><a href="/pages/af2fa0/" class="nav-link">《Spring源码轻松学》</a></li></ul></li><li class="dropdown-item"><h4>Spring Boot</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a18a7b/" class="nav-link">Spring Boot 2.0深度实践</a></li></ul></li><li class="dropdown-item"><h4>Spring Cloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f31975/" class="nav-link">Spring Cloud</a></li><li class="dropdown-subitem"><a href="/pages/722430/" class="nav-link">Spring Cloud Alibaba</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/630854/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/9b3698/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/c42700/" class="nav-link">Kafka</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4d1915/" class="nav-link">MySQL8.0详解</a></li><li class="dropdown-item"><!----> <a href="/pages/726b8d/" class="nav-link">Redis从入门到高可用</a></li><li class="dropdown-item"><!----> <a href="/pages/734bee/" class="nav-link">Elastic Stack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/foundation/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link">云原生</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">Devops</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">实用工具</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/reference/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li><li class="dropdown-item"><!----> <a href="/reference/" class="nav-link">Reference</a></li></ul></div></div> <a href="https://github.com/codeashen/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/codeashen/img-store/master/blog/public/avatar.jpg"> <div class="blogger-info"><h3>CodeAshen</h3> <span>后端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/32011a/" class="nav-link">《剖析Spring5核心原理》</a></li><li class="dropdown-subitem"><a href="/pages/af2fa0/" class="nav-link">《Spring源码轻松学》</a></li></ul></li><li class="dropdown-item"><h4>Spring Boot</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a18a7b/" class="nav-link">Spring Boot 2.0深度实践</a></li></ul></li><li class="dropdown-item"><h4>Spring Cloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f31975/" class="nav-link">Spring Cloud</a></li><li class="dropdown-subitem"><a href="/pages/722430/" class="nav-link">Spring Cloud Alibaba</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/630854/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/9b3698/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/c42700/" class="nav-link">Kafka</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4d1915/" class="nav-link">MySQL8.0详解</a></li><li class="dropdown-item"><!----> <a href="/pages/726b8d/" class="nav-link">Redis从入门到高可用</a></li><li class="dropdown-item"><!----> <a href="/pages/734bee/" class="nav-link">Elastic Stack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/foundation/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link">云原生</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">Devops</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">实用工具</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/reference/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li><li class="dropdown-item"><!----> <a href="/reference/" class="nav-link">Reference</a></li></ul></div></div> <a href="https://github.com/codeashen/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RabbitMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RocketMQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kafka</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2eda92/" class="sidebar-link">第01章-基础篇</a></li><li><a href="/pages/a93c71/" aria-current="page" class="active sidebar-link">第02章-场景实践篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a93c71/#_2-1-静态资源web服务" class="sidebar-link">2.1 静态资源web服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-1-1-静态资源服务场景-cdn" class="sidebar-link">2.1.1 静态资源服务场景-CDN</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-1-2-配置语法" class="sidebar-link">2.1.2 配置语法</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#文件读取" class="sidebar-link">文件读取</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#tcp-nopush" class="sidebar-link">tcp_nopush</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#tcp-nodelay" class="sidebar-link">tcp_nodelay</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#压缩" class="sidebar-link">压缩</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-1-3-nginx用于浏览器缓存" class="sidebar-link">2.1.3 Nginx用于浏览器缓存</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#浏览器缓存机制" class="sidebar-link">浏览器缓存机制</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93c71/#nginx配置缓存" class="sidebar-link">Nginx配置缓存</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-1-4-跨站访问" class="sidebar-link">2.1.4 跨站访问</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-1-5-防盗链" class="sidebar-link">2.1.5 防盗链</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93c71/#_2-2-代理服务" class="sidebar-link">2.2 代理服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-2-1-正向代理与反向代理" class="sidebar-link">2.2.1 正向代理与反向代理</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-2-2-代理模式和模块介绍" class="sidebar-link">2.2.2 代理模式和模块介绍</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-2-3-配置语法" class="sidebar-link">2.2.3 配置语法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93c71/#_2-3-负载均衡调度器slb" class="sidebar-link">2.3 负载均衡调度器SLB</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-3-1-负载均衡介绍及划分" class="sidebar-link">2.3.1 负载均衡介绍及划分</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-3-2-nginx负载均衡配置" class="sidebar-link">2.3.2 Nginx负载均衡配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-3-3-nginx调度算法" class="sidebar-link">2.3.3 Nginx调度算法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93c71/#_2-4-动态缓存" class="sidebar-link">2.4 动态缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-4-1-缓存分类和代理缓存" class="sidebar-link">2.4.1 缓存分类和代理缓存</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-4-2-缓存配置" class="sidebar-link">2.4.2 缓存配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93c71/#_2-4-3-请求分片" class="sidebar-link">2.4.3 请求分片</a></li></ul></li></ul></li><li><a href="/pages/0be3ee/" class="sidebar-link">第03章-深度学习篇</a></li><li><a href="/pages/ebfa36/" class="sidebar-link">第04章-架构篇</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/middleware/#中间件" data-v-06225672>中间件</a></li><li data-v-06225672><a href="/middleware/#Nginx" data-v-06225672>Nginx</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/codeashen" target="_blank" title="作者" class="beLink" data-v-06225672>CodeAshen</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-02-10</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">第02章-场景实践篇<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_2-1-静态资源web服务"><a href="#_2-1-静态资源web服务" class="header-anchor">#</a> 2.1 静态资源web服务</h2> <p><img src="https://s3.ax1x.com/2020/12/30/rOtZs1.png" alt="image-20201230175949359"></p> <h3 id="_2-1-1-静态资源服务场景-cdn"><a href="#_2-1-1-静态资源服务场景-cdn" class="header-anchor">#</a> 2.1.1 静态资源服务场景-CDN</h3> <p><img src="https://s3.ax1x.com/2020/12/30/rOtwFS.png" alt="image-20201230180215662"></p> <p>Nginx资源存储中心会把静态资源分发给“北京Nginx”，“湖南Nginx”，“山东Nginx”。</p> <p>然后北京User发送静态资源请求，通过CDN，找到离自己最近的“北京Nginx”。</p> <h3 id="_2-1-2-配置语法"><a href="#_2-1-2-配置语法" class="header-anchor">#</a> 2.1.2 配置语法</h3> <h4 id="文件读取"><a href="#文件读取" class="header-anchor">#</a> 文件读取</h4> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">sendfile on | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">sendfile off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location, if in location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>引：—with-file-aio 异步文件读取</p></blockquote> <h4 id="tcp-nopush"><a href="#tcp-nopush" class="header-anchor">#</a> tcp_nopush</h4> <p>作用：sendfile开启的情况下，提高网络包的传输效率</p> <p>把多个包整合，一次性发送，大文件传输推荐打开</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">tcp_nopush on | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">tcp_nopush off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="tcp-nodelay"><a href="#tcp-nodelay" class="header-anchor">#</a> tcp_nodelay</h4> <p>作用：keepalive连接下，提高网络包的传输实时性</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">tcp_nodelay on | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">tcp_nodelay on;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="压缩"><a href="#压缩" class="header-anchor">#</a> 压缩</h4> <p><strong>(1) 压缩开关</strong></p> <p>作用：传输压缩</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">gzip on | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">gzip off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location, if in location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://s3.ax1x.com/2020/12/30/rOgyZD.png" alt="image-20201230193145042"></p> <p><strong>(2) 压缩比</strong></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">gzip_comp_level level;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">gzip_comp_level 1;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>压缩比越高传输的数据包越小，但是压缩本身也会消耗服务端性能，需综合考虑</p> <p><strong>(3) 压缩内容</strong></p> <p>除了“text/html”之外，还为指定的MIME类型响应进行压缩。通配符“*”匹配任何MIME类型。“text/html”类型的响应总是被压缩的。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">gzip_types mime-type ...;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">gzip_types text/html;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>(4) 压缩需要的版本</strong></p> <p>设置压缩响应所需的请求的最低HTTP版本</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">gzip_http_version 1.0 | 1.1;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">gzip_http_version 1.1;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>(5) 预读压缩</strong></p> <p>优先响应原本已有的压缩文件，而不是压缩后再返回。</p> <p>例如，请求指定路径的 index.html，先检查该路径下是否存在 index.html.gz，如果存在直接响应该压缩文件，而不进行压缩了。节约了压缩时间，提高效率。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">gzip_static on | off | always;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">gzip_static off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>扩展Nginx压缩模块</strong></p> <ul><li>http_gzip_static_module：预读gzip功能</li> <li>http_gunzip_module：应用支持gunzip的压缩方式</li></ul> <h3 id="_2-1-3-nginx用于浏览器缓存"><a href="#_2-1-3-nginx用于浏览器缓存" class="header-anchor">#</a> 2.1.3 Nginx用于浏览器缓存</h3> <h4 id="浏览器缓存机制"><a href="#浏览器缓存机制" class="header-anchor">#</a> 浏览器缓存机制</h4> <p>浏览器缓存是基于HTTP协议定义的缓存机制（如：Expires；Cache-control等）</p> <p>浏览器无缓冲场景：</p> <p><img src="https://s3.ax1x.com/2020/12/31/rXWDnx.png" alt="image-20201231103949045"></p> <p>浏览器有缓存场景：</p> <p><img src="https://s3.ax1x.com/2020/12/31/rXf5RJ.png" alt="image-20201231104714049"></p> <p>缓存过期校验机制：</p> <table><thead><tr><th>校验点</th> <th>依赖的Header</th></tr></thead> <tbody><tr><td>校验是否过期</td> <td>Expires、Cache-Control(max-age)</td></tr> <tr><td>协议中Etag头信息校验</td> <td>Etag</td></tr> <tr><td>Last-Modified头信息校验</td> <td>Last-Modified</td></tr></tbody></table> <p>缓存过期校验步骤：</p> <ol><li><p>本地客户端通过Expires、Cache-Control（max-age）字段校验本地缓存是否过期。</p></li> <li><p>通过Etag头信息校验服务器缓存是否过期，如果不过期，不走第三步，否则执行下一步。</p></li> <li><p>通过Last-Modified头信息校验服务器缓存是否过期，如果不过期，直接返回，否则请求服务端。</p> <blockquote><ol><li>Expires出现在Http1.0版本；Cache-Control（max-age）出现在Http1.1版本；</li> <li>Etag的值是一串字符串，在一秒时间内更新的话，服务端是无法识别的，这个时候就需要Etag校验</li> <li>Last-Modified的值是具体时间：年-月-日 时:分:秒。Last-Modified用来跟服务端的缓存文件进行校验，如果服务端缓存文件在新的时间有新的更新，客户端请求的时间就会跟服务端缓存文件时间对比，这个时候就会出现客户端请求的时间跟服务端请求的时间不一致。 这样的话，服务端就会把最新的文件返回给客户端，这个利用的就是请求头中的Last-Modified头信息进行校验的。</li></ol></blockquote></li></ol> <p><img src="https://s3.ax1x.com/2020/12/31/rX5Evj.png" alt="image-20201231105859259"></p> <h4 id="nginx配置缓存"><a href="#nginx配置缓存" class="header-anchor">#</a> Nginx配置缓存</h4> <p>Nginx使用expires配置，在响应头中添加：Cache-Control、Expires头信息，实现缓存</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">expires [modified] time;</span>
<span class="token key attr-name">             expires</span> <span class="token value attr-value">epoch | max | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">expires off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location, if in location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>开启expires</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#设置缓存时间为30s
location ~ \.(html,htm)$ {
    expires 30s;
    root /opt/app/html;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第一次请求：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">######################  请求头  ######################</span>
<span class="token comment">#服务器设置缓存时间为30s</span>
<span class="token key attr-name">Cache-Control</span><span class="token punctuation">:</span> <span class="token value attr-value">max-age=30</span>
<span class="token comment">#最后修改时间，之后的请求都会放在If-Modified-Since里带上</span>
<span class="token key attr-name">Last-Modified</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 03:24:48 GMT</span>
<span class="token comment">#之后的请求都会放在If-None-Match里带上</span>
<span class="token key attr-name">ETag</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed4480-1e&quot;</span>
<span class="token comment">#缓存过期时间，每次都是 本次响应时间点+设置的过期时间</span>
<span class="token key attr-name">Expires</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 05:19:19 GMT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>第二次请求：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">######################  请求头  ######################</span>
<span class="token comment">#这个0是由浏览器加的，浏览器控制每次都让服务器做过期校验，决定返回的响应状态码</span>
<span class="token key attr-name">Cache-Control</span><span class="token punctuation">:</span> <span class="token value attr-value">max-age=0</span>
<span class="token comment">#第二次请求开始带上，校验Etag是否过期</span>
<span class="token key attr-name">If-None-Match</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed4480-1e&quot;</span>
<span class="token comment">#第二次请求开始带上，校验资源是否更改</span>
<span class="token key attr-name">If-Modified-Since</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 03:24:48 GMT</span>

<span class="token comment">######################  响应码  ######################</span>
<span class="token key attr-name">304</span> <span class="token value attr-value">Not Modified</span>
<span class="token comment">######################  响应头  ######################</span>
<span class="token key attr-name">Cache-Control</span><span class="token punctuation">:</span> <span class="token value attr-value">max-age=30</span>
<span class="token key attr-name">ETag</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed4480-1e&quot;</span>
<span class="token key attr-name">Expires</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 05:24:46 GMT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>未开启expires</strong></p> <p>第一次请求：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">######################  响应头  ######################</span>
<span class="token key attr-name">ETag</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed6c59-a&quot;</span>
<span class="token key attr-name">Last-Modified</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 06:14:49 GMT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第二次请求：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">######################  请求头  ######################</span>
<span class="token key attr-name">Cache-Control</span><span class="token punctuation">:</span> <span class="token value attr-value">max-age=0</span>
<span class="token key attr-name">If-Modified-Since</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 06:14:49 GMT</span>
<span class="token key attr-name">If-None-Match</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed6c59-a&quot;</span>

<span class="token comment">######################  响应码  ######################</span>
<span class="token key attr-name">304</span> <span class="token value attr-value">Not Modified</span>
<span class="token comment">######################  响应头  ######################</span>
<span class="token key attr-name">ETag</span><span class="token punctuation">:</span> <span class="token value attr-value">&quot;5fed6c59-a&quot;</span>
<span class="token key attr-name">Last-Modified</span><span class="token punctuation">:</span> <span class="token value attr-value">Thu, 31 Dec 2020 06:14:49 GMT</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-1-4-跨站访问"><a href="#_2-1-4-跨站访问" class="header-anchor">#</a> 2.1.4 跨站访问</h3> <p><img src="https://s3.ax1x.com/2020/12/31/rjnwR0.png" alt="image-20201231143844649"></p> <p>为什么浏览器禁止跨域访问不安全？容易出现CSRF攻击！</p> <p><img src="https://s3.ax1x.com/2020/12/31/rjqOLF.png" alt="image-20201231173341105"></p> <p>Nginx通过添加<strong>Access-Control-Allow-Origin</strong>响应头开启跨站访问</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">add_header name value [always];</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">http, server, location, if in location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置示例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\.(html|htm)$</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">add_header</span> Access-Control-Allow-Origin *</span><span class="token punctuation">;</span>
    root /opt/app/html
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-1-5-防盗链"><a href="#_2-1-5-防盗链" class="header-anchor">#</a> 2.1.5 防盗链</h3> <p>防止资源被盗用</p> <p>Nginx可以使用<code>http_refer</code>配置防盗链，该指令会根据Referer Header头的内容分配一个值为0或1给变量<code>$invalid_referer</code>。如果Referer Header头不符合<code>valid_referers</code>指令设置的有效Referer，变量<code>$invalid_referer</code>将被设置为1。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">valid_referers none | blocked | server_names | string ...;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该指令的参数可以为下面的内容：</p> <ul><li>none：表示无Referer值的情况。</li> <li>blocked：表示Referer值被防火墙进行伪装。</li> <li>server_names：表示一个或多个主机名称。0.5.33版本后server_names中可以使用通配符&quot;*&quot;</li></ul> <p>配置示例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> ~ .*\.(jpg|png|gif)$</span> <span class="token punctuation">{</span>
    <span class="token comment"># 验证规则</span>
    <span class="token directive"><span class="token keyword">valid_referers</span> none blocked server_names
               *.example.com example.* www.example.org/galleries/
               ~\.google\.</span><span class="token punctuation">;</span>
    <span class="token comment"># 校验不通过返回403</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">root</span> /opt/app/images</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_2-2-代理服务"><a href="#_2-2-代理服务" class="header-anchor">#</a> 2.2 代理服务</h2> <p><img src="https://s3.ax1x.com/2020/12/31/rvPPq1.png" alt="image-20201231182733547"></p> <h3 id="_2-2-1-正向代理与反向代理"><a href="#_2-2-1-正向代理与反向代理" class="header-anchor">#</a> 2.2.1 正向代理与反向代理</h3> <blockquote><p>代理区别在于代理的<strong>对象</strong>不一样。正向代理代理的对象是<strong>客户端</strong>，反向代理代理的对象是<strong>服务端</strong></p></blockquote> <p><strong>正向代理，是在用户端的</strong>。比如需要访问某些国外网站，我们可能需要购买vpn。</p> <p>并且<strong>vpn是在我们的用户浏览器端设置的</strong>(并不是在远端的服务器设置)。</p> <p>浏览器先访问vpn地址，vpn地址转发请求，并最后将请求结果原路返回来。</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcBqg.png" alt="image-20210104163625353"></p> <p><strong>反向代理是作用在服务器端的，是一个虚拟ip(VIP)</strong>。对于用户的一个请求，会转发到多个后端处理器中的一台来处理该具体请求。</p> <p>大型网站都有DNS(域名解析服务器)，load balance(负载均衡器)等。</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcrZQ.png" alt="image-20210104163724546"></p> <h3 id="_2-2-2-代理模式和模块介绍"><a href="#_2-2-2-代理模式和模块介绍" class="header-anchor">#</a> 2.2.2 代理模式和模块介绍</h3> <p><strong>Nginx可支持的代理协议：</strong></p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcNGt.png" alt="img"></p> <p><strong>反向代理</strong></p> <p>常见的Nginx作为反向代理支持的协议：</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcaxf.png" alt="img"></p> <p>反向代理模式与Nginx代理模块</p> <table><thead><tr><th>反向代理模式</th> <th>Nginx配置模块</th></tr></thead> <tbody><tr><td>http、websocket、https</td> <td>ngx_http_proxy_module</td></tr> <tr><td>fastcgi</td> <td>ngx_httpfastcgi_module</td></tr> <tr><td>uwsgi</td> <td>ngx_http_uwsgi_module</td></tr> <tr><td>grpc</td> <td>ngx_http_v2_module</td></tr></tbody></table> <p><strong>正向代理</strong></p> <p>常见的Nginx作为正向代理支持的协议</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcwM8.png" alt="img"></p> <p>注意：</p> <ul><li>不能支持使用HTTPS协议</li> <li>Nginx使用HTTP协议作为正向代理的协议</li> <li>Nginx使用正向代理范围比较窄</li></ul> <h3 id="_2-2-3-配置语法"><a href="#_2-2-3-配置语法" class="header-anchor">#</a> 2.2.3 配置语法</h3> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span>      <span class="token value attr-value">proxy_pass URL;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span>     <span class="token value attr-value">—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span>     <span class="token value attr-value">location, if in location, limit_except</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置示例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /name/</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:8080/<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>补充配置</strong></p> <p>1、缓存相关配置</p> <p>启用或禁用代理服务器响应的缓冲。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_buffering on | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_buffering on;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>扩展：proxy_buffer size、proxy_buffers、proxy_busy_ buffers_size</p> <p>2、跳转重定向</p> <p>修改被代理服务器返回的响应头中的location头域跟refresh头域数值</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_redirect default;</span>
<span class="token key attr-name">			proxy_redirect</span> <span class="token value attr-value">off;</span>
<span class="token key attr-name">			proxy_redirect</span> <span class="token value attr-value">redirect replacement;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_redirect default;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>https://blog.csdn.net/u010391029/article/details/50395680</p></blockquote> <p>3、头信息</p> <p>更改或新增传递给代理服务器的请求头</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_set_header field value;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_set_header Host $proxy_host;</span>
<span class="token key attr-name">			proxy_set_header</span> <span class="token value attr-value">Connection close;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>扩展：proxy_hide_header、proxy_set_body</p> <p>4、超时</p> <p>定义用于与代理服务器建立连接的超时。请注意，此超时通常不能超过75秒。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_connect_timeout time;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_connect_timeout 60s;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>扩展：proxy_read_timeout、proxy_send_timeout</p> <h2 id="_2-3-负载均衡调度器slb"><a href="#_2-3-负载均衡调度器slb" class="header-anchor">#</a> 2.3 负载均衡调度器SLB</h2> <h3 id="_2-3-1-负载均衡介绍及划分"><a href="#_2-3-1-负载均衡介绍及划分" class="header-anchor">#</a> 2.3.1 负载均衡介绍及划分</h3> <p><img src="https://s3.ax1x.com/2021/01/04/siY09s.png" alt="image-20210104181905203"></p> <p><strong>按作用范围可划分为 <em>GSLB</em> 和 <em>SLB</em></strong></p> <p><strong>1、GSLB（全局负载均衡）</strong></p> <p>GSLB 是英文Gobal Server Load Balance的缩写，意思是全局负载均衡。</p> <p>作用：实现在广域网(包括互联网)上不同地域的服务器间的流量调配，保证使用最佳的服务器服务离自己最近的客户，从而确保访问质量。</p> <p><img src="https://s3.ax1x.com/2021/01/04/siYyuV.png" alt="image-20210104182040699"></p> <ul><li>调度中心节点：一个全局的调度节点；</li> <li>调度节点：一个局部调度节点；</li> <li>应用服务中心节点：一个全局的应用服务调度节点；</li> <li>应用服务：一个局部应用服务节点；</li></ul> <p>调度中心节点管理着调度节点；应用服务中心节点管理着应用服务；</p> <blockquote><p>举例：</p> <p>第一步：张三请求局部调度节点，局部调度节点则返回服务地址给张三；
第二步：张三根据局部调度节点返回的服务地址，请求局部应用服务，局部应用服务则返回结果给张三。</p></blockquote> <p><strong>2、SLB（服务器负载均衡）</strong></p> <p><img src="https://s3.ax1x.com/2021/01/04/siY6BT.png" alt="image-20210104182358524"></p> <p>调度节点与服务节点处于一个逻辑单元里面，这样对于部分服务的实时性、响应性是非常好的。</p> <p><strong>按七层网络模型课划分为 <em>四层负载均衡</em> 和 <em>七层负载均衡</em></strong></p> <p><strong>1、四层负载均衡</strong>，即传输层负载均衡</p> <p><img src="https://s3.ax1x.com/2021/01/04/siYcHU.png" alt="image-20210104182619957"></p> <p>按照网络OSI模型可以分为四层负载均衡和七层负载均衡；</p> <p>四层负载均衡：在OSI模型里面的传输层，传输层能支持到tcp/ip协议，所以只需要转发tcp/ip协议的包，就可以实现负载均衡。</p> <p>优势：性能非常好，只需要在最底层应用处理，而不需要进行一些复杂的逻辑，只需要包的转发就行</p> <p><strong>2、七层负载均衡</strong>，处理应用层，如：http信息</p> <p><img src="https://s3.ax1x.com/2021/01/04/siY2EF.png" alt="image-20210104182704000"></p> <p>七层负载均衡主要是在应用层使用，所以它可以完成很多应用层的协议请求，比如HTTP协议的负载均衡，它可以实现HTTP信息的改写，头信息的改写，应用规则的控制。</p> <p><strong>Nginx是典型的七层负载均衡SLB。</strong></p> <h3 id="_2-3-2-nginx负载均衡配置"><a href="#_2-3-2-nginx负载均衡配置" class="header-anchor">#</a> 2.3.2 Nginx负载均衡配置</h3> <p>Nginx负载均衡配置是基于 <em>proxy_pass</em> 和 <em>upstream</em> 实现的。如下图：upstream server就相当于配置的虚拟服务池。</p> <p><img src="https://s3.ax1x.com/2021/01/04/siYRN4.png" alt="image-20210104185540581"></p> <p><strong>upstream</strong>配置</p> <p>定义一组服务器。服务器可以在不同的端口上侦听。此外，可以混合使用侦听TCP和UNIX域套接字的服务器。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		upstream name { ... }</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置示例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># 定义一组服务器</span>
<span class="token directive"><span class="token keyword">upstream</span> lucifer</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
	
	<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
		<span class="token comment"># 使用upstream定义的服务器组负载均衡</span>
		proxy_pass http://lucifer
	<span class="token punctuation">}</span>
	
	......
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>upstream详解</strong></p> <p>官方示例</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> backend</span> <span class="token punctuation">{</span>
	<span class="token comment"># 加权重</span>
    <span class="token directive"><span class="token keyword">server</span> backend1.example.com weight=5</span><span class="token punctuation">;</span>
    <span class="token comment"># 指定最大失败次数和暂停服务时间</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8080       max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span>
    <span class="token comment"># socket方式</span>
    <span class="token directive"><span class="token keyword">server</span> unix:/tmp/backend3</span><span class="token punctuation">;</span>
	<span class="token comment"># 备份节点</span>
    <span class="token directive"><span class="token keyword">server</span> backup1.example.com  backup</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>附加配置项含义：</p> <table><thead><tr><th>配置</th> <th>含义</th></tr></thead> <tbody><tr><td>down</td> <td>当前的server暂时不参与负载均衡</td></tr> <tr><td>backup</td> <td>预留的备份服务器</td></tr> <tr><td>max_fails</td> <td>允许请求失败的次数</td></tr> <tr><td>fail_timeout</td> <td>经过max_fails失败后，服务暂停的时间</td></tr> <tr><td>max_conns</td> <td>限制最大的接收的连接数</td></tr></tbody></table> <h3 id="_2-3-3-nginx调度算法"><a href="#_2-3-3-nginx调度算法" class="header-anchor">#</a> 2.3.3 Nginx调度算法</h3> <table><thead><tr><th>调度方式</th> <th>解释</th></tr></thead> <tbody><tr><td>轮询</td> <td>按时间顺序逐一分配到不同的后端服务器</td></tr> <tr><td>加权轮询</td> <td>weight值越大，分配到的访问几率越高</td></tr> <tr><td>ip_hash</td> <td>每个请求按访问IP的hash结果分配，这样来自同一个IP的固定访问一个后端服务器</td></tr> <tr><td>url_hash</td> <td>按照访问的URL的hash结果来分配请求，是每个URL定向到同一个后端服务器</td></tr> <tr><td>least_conn</td> <td>最少链接数，那个机器连接数少就分发</td></tr> <tr><td>hash关键数值</td> <td>hash自定义的key</td></tr></tbody></table> <p><strong>1、weight加权轮询配置</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> lucifer</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082 weight=5</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>2、ip_hash配置</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> lucifer</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">ip_hash</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>3、url_hash配置</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">upstream</span> lucifer</span> <span class="token punctuation">{</span>
	<span class="token directive"><span class="token keyword">hash</span> <span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8081</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8082</span><span class="token punctuation">;</span>
	<span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8083</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-4-动态缓存"><a href="#_2-4-动态缓存" class="header-anchor">#</a> 2.4 动态缓存</h2> <h3 id="_2-4-1-缓存分类和代理缓存"><a href="#_2-4-1-缓存分类和代理缓存" class="header-anchor">#</a> 2.4.1 缓存分类和代理缓存</h3> <p>缓存可分为服务端缓存、代理缓存、客户端缓存，Nginx配置缓存是代理缓存。</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcmP1.png" alt="image-20210105100929611"></p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcn8x.png" alt="image-20210105100946619"></p> <p><img src="https://s3.ax1x.com/2021/01/05/sFcQKO.png" alt="image-20210105100910044"></p> <p>Nginx代理缓存生效流程：</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFc8VH.png" alt="img"></p> <ol><li>客户端第一次向Nginx请求数据a；</li> <li>当Nginx发现缓存中没有数据a时，会向服务端请求数据a；</li> <li>服务端接收到Nginx发来的请求，则返回数据a到Nginx，并且缓存在Nginx；</li> <li>Nginx返回数据a给客户端应用；</li> <li>客户端第二次向Nginx请求数据a；</li> <li>当Nginx发现缓存中存在数据a时，则不会请求服务端，直接将缓存中的数据放回给客户端。</li></ol> <h3 id="_2-4-2-缓存配置"><a href="#_2-4-2-缓存配置" class="header-anchor">#</a> 2.4.2 缓存配置</h3> <p><strong>1、proxy_cache_path</strong></p> <p>设置缓存的路径和其他参数。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [min_free=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>2、proxy_cache</strong></p> <p>定义用于缓存的共享内存区域。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_cache zone | off;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_cache off;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>3、proxy_cache_valid</strong></p> <p>为不同的响应状态码设置缓存时间。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_cache_valid [code ...] time;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>4、proxy_cache_key</strong></p> <p>定义用于缓存的key。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_cache_key string;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	proxy_cache_key $scheme$proxy_host$request_uri;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>5、proxy_no_cache</strong></p> <p>配置不缓存的条件。如果字符串参数中至少有一个值不为空且不等于“0”，则不会缓存响应。</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		proxy_no_cache string ...;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	—</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>7、配置实例</strong></p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token comment"># 定义服务器组</span>
<span class="token directive"><span class="token keyword">upstream</span> lucifer</span> <span class="token punctuation">{</span> 
	server 116.62.103.228:8001； 
	server 116.62.103.228:8002； 
	server 116.62.103.228:8003；
<span class="token punctuation">}</span>	

<span class="token comment"># 缓存路径 缓存目录层次结构级别 定义key空间名和大小 目录最大容量 不活跃失效时间 关闭临时文件</span>
<span class="token directive"><span class="token keyword">proxy_cache_path</span> /opt/app/cache levels=1:2 keys_zone=lucifer_cache:10m max_size=10g inactive=60m use_temp_path=off</span><span class="token punctuation">;</span> 

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span> 

	<span class="token comment"># 如果请求uri符合条件，则设置$cookie_nocache值为1</span>
	<span class="token directive"><span class="token keyword">if($request_uri</span> ~ ^/(url3|login|register|password\/reset))</span> <span class="token punctuation">{</span> 
		<span class="token directive"><span class="token keyword">set</span> <span class="token variable">$cookie_nocache</span> <span class="token number">1</span></span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span> 
		<span class="token comment"># 使用定义的key空间</span>
		<span class="token directive"><span class="token keyword">proxy_cache</span> lucifer_cache</span><span class="token punctuation">;</span> 
		<span class="token directive"><span class="token keyword">proxy_pass</span> http://lucifer</span><span class="token punctuation">;</span> 
		<span class="token comment"># 针对不同的响应状态码设置缓存时间</span>
		<span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">304</span> <span class="token number">12h</span></span><span class="token punctuation">;</span> 
		<span class="token directive"><span class="token keyword">proxy_cache_valid</span> any <span class="token number">10m</span></span><span class="token punctuation">;</span> 
		<span class="token comment"># 设置缓存key</span>
		<span class="token directive"><span class="token keyword">proxy_cache_key</span> <span class="token variable">$host</span><span class="token variable">$uri</span><span class="token variable">$is_args</span><span class="token variable">$args</span></span><span class="token punctuation">;</span> 
		<span class="token comment"># 加入头信息以直观感受是否命中缓存</span>
		<span class="token directive"><span class="token keyword">add_header</span> Nginx-Cache <span class="token string">&quot;<span class="token variable">$upstream_cache_status</span>&quot;</span></span><span class="token punctuation">;</span> 
		<span class="token comment"># 配置不缓存的条件，只要有一个参数不为0，就不缓存</span>
		<span class="token directive"><span class="token keyword">proxy_no_cache</span> <span class="token variable">$cookie_nocache</span> <span class="token variable">$arg_nocache</span> <span class="token variable">$arg_comment</span></span><span class="token punctuation">;</span>
		<span class="token directive"><span class="token keyword">proxy_no_cache</span> <span class="token variable">$http_pragma</span> <span class="token variable">$http_authorization</span></span><span class="token punctuation">;</span>
		
		<span class="token comment"># 配置出现指定错误时，跳过本台服务器去尝试下一台服务器</span>
		<span class="token directive"><span class="token keyword">proxy_next_upstream</span> error timeout invalid_header http_ <span class="token number">500</span> http_502 http_503 http_504</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>8、场景配置补充说明</strong></p> <p>如何清理指定缓存?</p> <ul><li>方式一：rm -rf 缓存目录内容</li> <li>方式二：第三方扩展模块ngx_cache_purge</li></ul> <h3 id="_2-4-3-请求分片"><a href="#_2-4-3-请求分片" class="header-anchor">#</a> 2.4.3 请求分片</h3> <p>ngx_http_slice_module模块将一个请求拆分为子请求，每个子请求返回一定范围的响应。</p> <p>默认情况下不生成此模块，应使用--with-http\u slice\u module配置参数启用它。</p> <p><img src="https://s3.ax1x.com/2021/01/05/sFclrD.png" alt="image-20210105114035661"></p> <ul><li>优点：每个子请求收到的数据都会形成一个独立的文件，一个请求断了，其他请求不会收到影响。</li> <li>缺点：当文件很大或者slice设置很小时，可能会导致文件描述符耗尽等情况。</li></ul> <p>配置语法：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">Syntax</span><span class="token punctuation">:</span><span class="token value attr-value">		slice size;</span>
<span class="token key attr-name">Default</span><span class="token punctuation">:</span><span class="token value attr-value">	slice 0;</span>
<span class="token key attr-name">Context</span><span class="token punctuation">:</span><span class="token value attr-value">	http, server, location</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置实例：</p> <div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">slice</span>             <span class="token number">1m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_cache</span>       cache</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_cache_key</span>   <span class="token variable">$uri</span><span class="token variable">$is_args</span><span class="token variable">$args</span><span class="token variable">$slice_range</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_set_header</span>  Range <span class="token variable">$slice_range</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">206</span> <span class="token number">1h</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span>        http://localhost:8000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>此示例中，响应被分为1m的可缓存片。</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/codeashen/notes/edit/master/docs/02.中间件/04.Nginx/02.场景实践篇.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/06/04, 12:34:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/2eda92/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第01章-基础篇</div></a> <a href="/pages/0be3ee/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第03章-深度学习篇</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/2eda92/" class="prev">第01章-基础篇</a></span> <span class="next"><a href="/pages/0be3ee/">第03章-深度学习篇</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/630854/"><div>
            第01章-RabbitMQ导学
            <!----></div></a> <span class="date">02-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/c2f425/"><div>
            第02章-入门RabbitMQ核心概念
            <!----></div></a> <span class="date">02-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b09a03/"><div>
            第03章-RabbitMQ高级特性
            <!----></div></a> <span class="date">02-10</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:codeashen@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/codeashen" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://space.bilibili.com/7403658/" title="BiliBili" target="_blank" class="iconfont icon-bilibili"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2023
    <span>CodeAshen | <a href="https://github.com/codeashen/notes/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.973ec296.js" defer></script><script src="/assets/js/2.6aaa6d1e.js" defer></script><script src="/assets/js/43.4e6aa9e5.js" defer></script>
  </body>
</html>
