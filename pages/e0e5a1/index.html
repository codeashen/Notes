<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第08章-Redis Cluster | CodeAshen&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="后端技术博客,专注后端技术学习与总结。Java,Python,JavaScript,TypeScript,Spring,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="后端博客,个人技术博客,后端,后端开发,后端框架,后端面试题,技术文档,学习,面试,Java,Python,JavaScript,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.d9c8cf8c.css" as="style"><link rel="preload" href="/assets/js/app.973ec296.js" as="script"><link rel="preload" href="/assets/js/2.6aaa6d1e.js" as="script"><link rel="preload" href="/assets/js/70.ad84b59a.js" as="script"><link rel="prefetch" href="/assets/js/10.c128a7de.js"><link rel="prefetch" href="/assets/js/100.c5332952.js"><link rel="prefetch" href="/assets/js/101.472590ad.js"><link rel="prefetch" href="/assets/js/102.f697d18e.js"><link rel="prefetch" href="/assets/js/103.d8218fae.js"><link rel="prefetch" href="/assets/js/104.8851b38a.js"><link rel="prefetch" href="/assets/js/105.e9164174.js"><link rel="prefetch" href="/assets/js/106.fb403dea.js"><link rel="prefetch" href="/assets/js/107.ea7dbfb9.js"><link rel="prefetch" href="/assets/js/108.841273d4.js"><link rel="prefetch" href="/assets/js/109.a01a78fe.js"><link rel="prefetch" href="/assets/js/11.8d1708c7.js"><link rel="prefetch" href="/assets/js/110.8f5d172e.js"><link rel="prefetch" href="/assets/js/111.524e2bcf.js"><link rel="prefetch" href="/assets/js/112.b8a747e9.js"><link rel="prefetch" href="/assets/js/113.a9b1b9a0.js"><link rel="prefetch" href="/assets/js/114.7e4041d8.js"><link rel="prefetch" href="/assets/js/115.e2882f73.js"><link rel="prefetch" href="/assets/js/116.1d415864.js"><link rel="prefetch" href="/assets/js/117.71e63524.js"><link rel="prefetch" href="/assets/js/118.8986f793.js"><link rel="prefetch" href="/assets/js/119.80bcd61e.js"><link rel="prefetch" href="/assets/js/12.0132831e.js"><link rel="prefetch" href="/assets/js/120.dc2754a6.js"><link rel="prefetch" href="/assets/js/121.1dbe4441.js"><link rel="prefetch" href="/assets/js/122.446eb0a0.js"><link rel="prefetch" href="/assets/js/123.bac389f3.js"><link rel="prefetch" href="/assets/js/124.c087aa83.js"><link rel="prefetch" href="/assets/js/125.dcec8498.js"><link rel="prefetch" href="/assets/js/126.7e932ea3.js"><link rel="prefetch" href="/assets/js/127.2ae0bcd8.js"><link rel="prefetch" href="/assets/js/128.2d4ad1d9.js"><link rel="prefetch" href="/assets/js/129.4d6a08f8.js"><link rel="prefetch" href="/assets/js/13.209ff1e9.js"><link rel="prefetch" href="/assets/js/130.8936ad8a.js"><link rel="prefetch" href="/assets/js/131.11ca372c.js"><link rel="prefetch" href="/assets/js/132.9be75880.js"><link rel="prefetch" href="/assets/js/133.9955d166.js"><link rel="prefetch" href="/assets/js/134.5be1b51a.js"><link rel="prefetch" href="/assets/js/135.d0f8d2e0.js"><link rel="prefetch" href="/assets/js/136.ca304a24.js"><link rel="prefetch" href="/assets/js/137.1a0a904c.js"><link rel="prefetch" href="/assets/js/138.8ab30fee.js"><link rel="prefetch" href="/assets/js/139.cf78c4d4.js"><link rel="prefetch" href="/assets/js/14.d6134190.js"><link rel="prefetch" href="/assets/js/140.6c61677f.js"><link rel="prefetch" href="/assets/js/141.51ef4f6a.js"><link rel="prefetch" href="/assets/js/142.5a2feec0.js"><link rel="prefetch" href="/assets/js/143.f7200d74.js"><link rel="prefetch" href="/assets/js/144.1c36af9b.js"><link rel="prefetch" href="/assets/js/145.2ba88ed7.js"><link rel="prefetch" href="/assets/js/146.7ddd636f.js"><link rel="prefetch" href="/assets/js/147.835c06fe.js"><link rel="prefetch" href="/assets/js/148.5bfc3184.js"><link rel="prefetch" href="/assets/js/149.15658978.js"><link rel="prefetch" href="/assets/js/15.10140158.js"><link rel="prefetch" href="/assets/js/150.f1414565.js"><link rel="prefetch" href="/assets/js/151.6fe4a9f2.js"><link rel="prefetch" href="/assets/js/152.0694636f.js"><link rel="prefetch" href="/assets/js/153.d4a79e2b.js"><link rel="prefetch" href="/assets/js/154.f49c40b1.js"><link rel="prefetch" href="/assets/js/155.11c4af47.js"><link rel="prefetch" href="/assets/js/156.17a27449.js"><link rel="prefetch" href="/assets/js/157.03222e94.js"><link rel="prefetch" href="/assets/js/158.fd10abd2.js"><link rel="prefetch" href="/assets/js/159.7854cf98.js"><link rel="prefetch" href="/assets/js/16.deabf74a.js"><link rel="prefetch" href="/assets/js/160.bcceda6c.js"><link rel="prefetch" href="/assets/js/161.827af027.js"><link rel="prefetch" href="/assets/js/162.855aca43.js"><link rel="prefetch" href="/assets/js/163.72d27148.js"><link rel="prefetch" href="/assets/js/164.3e01c09c.js"><link rel="prefetch" href="/assets/js/165.e652258b.js"><link rel="prefetch" href="/assets/js/166.ecaa4581.js"><link rel="prefetch" href="/assets/js/167.e8ff99fa.js"><link rel="prefetch" href="/assets/js/168.02abfd0d.js"><link rel="prefetch" href="/assets/js/169.8fbd2db6.js"><link rel="prefetch" href="/assets/js/17.f69b8f6b.js"><link rel="prefetch" href="/assets/js/170.69e15007.js"><link rel="prefetch" href="/assets/js/171.cf706d56.js"><link rel="prefetch" href="/assets/js/172.3e4c3668.js"><link rel="prefetch" href="/assets/js/173.6ff18f12.js"><link rel="prefetch" href="/assets/js/174.453f4245.js"><link rel="prefetch" href="/assets/js/175.063163ca.js"><link rel="prefetch" href="/assets/js/176.edf6516c.js"><link rel="prefetch" href="/assets/js/177.c6ea414e.js"><link rel="prefetch" href="/assets/js/178.da8150fd.js"><link rel="prefetch" href="/assets/js/179.98958ecb.js"><link rel="prefetch" href="/assets/js/18.1a578fab.js"><link rel="prefetch" href="/assets/js/180.a98d2988.js"><link rel="prefetch" href="/assets/js/181.e7d9677d.js"><link rel="prefetch" href="/assets/js/182.dcae9e42.js"><link rel="prefetch" href="/assets/js/183.aee29579.js"><link rel="prefetch" href="/assets/js/184.98755068.js"><link rel="prefetch" href="/assets/js/185.82f47215.js"><link rel="prefetch" href="/assets/js/186.442d78c2.js"><link rel="prefetch" href="/assets/js/187.b37b3a63.js"><link rel="prefetch" href="/assets/js/188.b2405297.js"><link rel="prefetch" href="/assets/js/189.b3b59e8a.js"><link rel="prefetch" href="/assets/js/19.395617bc.js"><link rel="prefetch" href="/assets/js/190.ca137199.js"><link rel="prefetch" href="/assets/js/191.aa8a7422.js"><link rel="prefetch" href="/assets/js/192.270c2e56.js"><link rel="prefetch" href="/assets/js/193.e9d382d3.js"><link rel="prefetch" href="/assets/js/194.4d804198.js"><link rel="prefetch" href="/assets/js/195.b5b758e9.js"><link rel="prefetch" href="/assets/js/196.81bdc47b.js"><link rel="prefetch" href="/assets/js/197.3dd5c487.js"><link rel="prefetch" href="/assets/js/198.49c5c5e0.js"><link rel="prefetch" href="/assets/js/199.e4e9ff5b.js"><link rel="prefetch" href="/assets/js/20.af9c51b5.js"><link rel="prefetch" href="/assets/js/200.137782e2.js"><link rel="prefetch" href="/assets/js/201.cb4e5b2b.js"><link rel="prefetch" href="/assets/js/202.51abb277.js"><link rel="prefetch" href="/assets/js/203.83ed2d8a.js"><link rel="prefetch" href="/assets/js/21.cac71621.js"><link rel="prefetch" href="/assets/js/22.c51a3f6c.js"><link rel="prefetch" href="/assets/js/23.d9987c58.js"><link rel="prefetch" href="/assets/js/24.0b2c6cb2.js"><link rel="prefetch" href="/assets/js/25.c5aaf6b9.js"><link rel="prefetch" href="/assets/js/26.c4307053.js"><link rel="prefetch" href="/assets/js/27.27c8f8d4.js"><link rel="prefetch" href="/assets/js/28.b884b191.js"><link rel="prefetch" href="/assets/js/29.11a7cac3.js"><link rel="prefetch" href="/assets/js/3.52039520.js"><link rel="prefetch" href="/assets/js/30.e0296187.js"><link rel="prefetch" href="/assets/js/31.f612d60e.js"><link rel="prefetch" href="/assets/js/32.da15f932.js"><link rel="prefetch" href="/assets/js/33.06c4feab.js"><link rel="prefetch" href="/assets/js/34.fa726970.js"><link rel="prefetch" href="/assets/js/35.5dfa35dd.js"><link rel="prefetch" href="/assets/js/36.e8ee6c32.js"><link rel="prefetch" href="/assets/js/37.f34d8356.js"><link rel="prefetch" href="/assets/js/38.db8e9d1d.js"><link rel="prefetch" href="/assets/js/39.2d902803.js"><link rel="prefetch" href="/assets/js/4.94dce7a4.js"><link rel="prefetch" href="/assets/js/40.9b2c544f.js"><link rel="prefetch" href="/assets/js/41.bce99484.js"><link rel="prefetch" href="/assets/js/42.a0c6c78b.js"><link rel="prefetch" href="/assets/js/43.4e6aa9e5.js"><link rel="prefetch" href="/assets/js/44.ef9352e3.js"><link rel="prefetch" href="/assets/js/45.ae779112.js"><link rel="prefetch" href="/assets/js/46.fb4a183c.js"><link rel="prefetch" href="/assets/js/47.fae1056f.js"><link rel="prefetch" href="/assets/js/48.56b0b378.js"><link rel="prefetch" href="/assets/js/49.a6f88870.js"><link rel="prefetch" href="/assets/js/5.e01aaa8d.js"><link rel="prefetch" href="/assets/js/50.83e82362.js"><link rel="prefetch" href="/assets/js/51.e9419834.js"><link rel="prefetch" href="/assets/js/52.a1967369.js"><link rel="prefetch" href="/assets/js/53.94af57c3.js"><link rel="prefetch" href="/assets/js/54.b50e8783.js"><link rel="prefetch" href="/assets/js/55.8063724b.js"><link rel="prefetch" href="/assets/js/56.76bf8a2a.js"><link rel="prefetch" href="/assets/js/57.f9f3f777.js"><link rel="prefetch" href="/assets/js/58.f5fc8f65.js"><link rel="prefetch" href="/assets/js/59.6d369d87.js"><link rel="prefetch" href="/assets/js/6.07a7065d.js"><link rel="prefetch" href="/assets/js/60.5d94a162.js"><link rel="prefetch" href="/assets/js/61.0ad7c924.js"><link rel="prefetch" href="/assets/js/62.85956477.js"><link rel="prefetch" href="/assets/js/63.7e5be0fc.js"><link rel="prefetch" href="/assets/js/64.fbae5632.js"><link rel="prefetch" href="/assets/js/65.ddcfdbe6.js"><link rel="prefetch" href="/assets/js/66.b3dfda7e.js"><link rel="prefetch" href="/assets/js/67.6ee30a4e.js"><link rel="prefetch" href="/assets/js/68.71e1e060.js"><link rel="prefetch" href="/assets/js/69.4ed5537a.js"><link rel="prefetch" href="/assets/js/7.7a33a5a5.js"><link rel="prefetch" href="/assets/js/71.136b2322.js"><link rel="prefetch" href="/assets/js/72.49c8fc99.js"><link rel="prefetch" href="/assets/js/73.7b0351b5.js"><link rel="prefetch" href="/assets/js/74.e7a0ce34.js"><link rel="prefetch" href="/assets/js/75.fc40be0c.js"><link rel="prefetch" href="/assets/js/76.bc90d4b8.js"><link rel="prefetch" href="/assets/js/77.0cb653a2.js"><link rel="prefetch" href="/assets/js/78.b692f5f9.js"><link rel="prefetch" href="/assets/js/79.effdc1de.js"><link rel="prefetch" href="/assets/js/8.17467f67.js"><link rel="prefetch" href="/assets/js/80.87603bda.js"><link rel="prefetch" href="/assets/js/81.4c9aac1e.js"><link rel="prefetch" href="/assets/js/82.54ab2e24.js"><link rel="prefetch" href="/assets/js/83.d34317d2.js"><link rel="prefetch" href="/assets/js/84.093a866c.js"><link rel="prefetch" href="/assets/js/85.dfe1b6bc.js"><link rel="prefetch" href="/assets/js/86.ffef04fb.js"><link rel="prefetch" href="/assets/js/87.52805dce.js"><link rel="prefetch" href="/assets/js/88.dd97eda8.js"><link rel="prefetch" href="/assets/js/89.425cc035.js"><link rel="prefetch" href="/assets/js/9.a64e81dc.js"><link rel="prefetch" href="/assets/js/90.3e58b256.js"><link rel="prefetch" href="/assets/js/91.711a6bba.js"><link rel="prefetch" href="/assets/js/92.3cc169cd.js"><link rel="prefetch" href="/assets/js/93.4e7bbb8c.js"><link rel="prefetch" href="/assets/js/94.e5c6ff23.js"><link rel="prefetch" href="/assets/js/95.adc48da9.js"><link rel="prefetch" href="/assets/js/96.84e8c33b.js"><link rel="prefetch" href="/assets/js/97.61e63949.js"><link rel="prefetch" href="/assets/js/98.fc0fb11b.js"><link rel="prefetch" href="/assets/js/99.b473d996.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d9c8cf8c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="CodeAshen's blog" class="logo"> <span class="site-name can-hide">CodeAshen's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/32011a/" class="nav-link">《剖析Spring5核心原理》</a></li><li class="dropdown-subitem"><a href="/pages/af2fa0/" class="nav-link">《Spring源码轻松学》</a></li></ul></li><li class="dropdown-item"><h4>Spring Boot</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a18a7b/" class="nav-link">Spring Boot 2.0深度实践</a></li></ul></li><li class="dropdown-item"><h4>Spring Cloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f31975/" class="nav-link">Spring Cloud</a></li><li class="dropdown-subitem"><a href="/pages/722430/" class="nav-link">Spring Cloud Alibaba</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/630854/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/9b3698/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/c42700/" class="nav-link">Kafka</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4d1915/" class="nav-link">MySQL8.0详解</a></li><li class="dropdown-item"><!----> <a href="/pages/726b8d/" class="nav-link">Redis从入门到高可用</a></li><li class="dropdown-item"><!----> <a href="/pages/734bee/" class="nav-link">Elastic Stack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/foundation/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link">云原生</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">Devops</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">实用工具</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/reference/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li><li class="dropdown-item"><!----> <a href="/reference/" class="nav-link">Reference</a></li></ul></div></div> <a href="https://github.com/codeashen/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.staticaly.com/gh/codeashen/img-store/master/blog/public/avatar.jpg"> <div class="blogger-info"><h3>CodeAshen</h3> <span>后端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring" class="dropdown-title"><a href="/spring/" class="link-title">Spring</a> <span class="title" style="display:none;">Spring</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Spring Framework</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/32011a/" class="nav-link">《剖析Spring5核心原理》</a></li><li class="dropdown-subitem"><a href="/pages/af2fa0/" class="nav-link">《Spring源码轻松学》</a></li></ul></li><li class="dropdown-item"><h4>Spring Boot</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a18a7b/" class="nav-link">Spring Boot 2.0深度实践</a></li></ul></li><li class="dropdown-item"><h4>Spring Cloud</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f31975/" class="nav-link">Spring Cloud</a></li><li class="dropdown-subitem"><a href="/pages/722430/" class="nav-link">Spring Cloud Alibaba</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/630854/" class="nav-link">RabbitMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/9b3698/" class="nav-link">RocketMQ</a></li><li class="dropdown-item"><!----> <a href="/pages/c42700/" class="nav-link">Kafka</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4d1915/" class="nav-link">MySQL8.0详解</a></li><li class="dropdown-item"><!----> <a href="/pages/726b8d/" class="nav-link">Redis从入门到高可用</a></li><li class="dropdown-item"><!----> <a href="/pages/734bee/" class="nav-link">Elastic Stack</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="内功心法" class="dropdown-title"><a href="/foundation/" class="link-title">内功心法</a> <span class="title" style="display:none;">内功心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/" class="nav-link">操作系统</a></li><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/algorithm/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link">云原生</a></li><li class="dropdown-item"><!----> <a href="/devops/" class="nav-link">Devops</a></li><li class="dropdown-item"><!----> <a href="/frontend/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/tools/" class="nav-link">实用工具</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/reference/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li><li class="dropdown-item"><!----> <a href="/reference/" class="nav-link">Reference</a></li></ul></div></div> <a href="https://github.com/codeashen/notes" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL8.0详解与实战</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MySQL面试指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Redis从入门到高可用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/726b8d/" class="sidebar-link">第01章-初识Redis</a></li><li><a href="/pages/9e9f2b/" class="sidebar-link">第02章-API理解和使用</a></li><li><a href="/pages/45a245/" class="sidebar-link">第03章-Redis客户端</a></li><li><a href="/pages/0a5b30/" class="sidebar-link">第04章-Redis其他功能</a></li><li><a href="/pages/dc120a/" class="sidebar-link">第05章-Redis持久化</a></li><li><a href="/pages/a290a1/" class="sidebar-link">第06章-Redis主从复制</a></li><li><a href="/pages/21251e/" class="sidebar-link">第07章-Redis Sentinel</a></li><li><a href="/pages/e0e5a1/" aria-current="page" class="active sidebar-link">第08章-Redis Cluster</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_2-1-数据分区方式" class="sidebar-link">2.1 数据分区方式</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_2-2-节点取余分区" class="sidebar-link">2.2 节点取余分区</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_2-3-一致性哈希分区" class="sidebar-link">2.3 一致性哈希分区</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_2-4-虚拟槽分区" class="sidebar-link">2.4 虚拟槽分区</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_3-1-基本架构" class="sidebar-link">3.1 基本架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#单体架构" class="sidebar-link">单体架构</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#分布式架构" class="sidebar-link">分布式架构</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#redis-cluster架构" class="sidebar-link">Redis Cluster架构</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_3-3-搭建集群-原生命令安装" class="sidebar-link">3.3 搭建集群（原生命令安装）</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_3-4-搭建集群-官方工具-redis-trib" class="sidebar-link">3.4 搭建集群（官方工具 redis-trib）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#ruby-环境准备" class="sidebar-link">ruby 环境准备</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#搭建集群" class="sidebar-link">搭建集群</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_3-5-总结" class="sidebar-link">3.5 总结</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_4-1-伸缩原理" class="sidebar-link">4.1 伸缩原理</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_4-2-扩容集群" class="sidebar-link">4.2 扩容集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#准备新节点" class="sidebar-link">准备新节点</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#加入集群" class="sidebar-link">加入集群</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#迁移槽和数据" class="sidebar-link">迁移槽和数据</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_4-3-缩容集群" class="sidebar-link">4.3 缩容集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#下线槽" class="sidebar-link">下线槽</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#忘记节点" class="sidebar-link">忘记节点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_5-1-moved重定向" class="sidebar-link">5.1 moved重定向</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_5-2-ask重定向" class="sidebar-link">5.2 ask重定向</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_5-3-smart-客户端" class="sidebar-link">5.3 smart 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#smart-客户端原理" class="sidebar-link">smart 客户端原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#smart-客户端使用-jediscluster" class="sidebar-link">smart 客户端使用：JedisCluster</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_6-1-故障发现" class="sidebar-link">6.1 故障发现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#主观下线" class="sidebar-link">主观下线</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#客观下线" class="sidebar-link">客观下线</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_6-2-故障恢复" class="sidebar-link">6.2 故障恢复</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#资格检查" class="sidebar-link">资格检查</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#准备选举时间" class="sidebar-link">准备选举时间</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#选举投票" class="sidebar-link">选举投票</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#替换主节点" class="sidebar-link">替换主节点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-1-集群完整性" class="sidebar-link">7.1 集群完整性</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-2-带宽消耗" class="sidebar-link">7.2 带宽消耗</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-3-pub-sub-广播" class="sidebar-link">7.3 Pub/Sub 广播</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-4-数据倾斜" class="sidebar-link">7.4 数据倾斜</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#数据倾斜-内存不均" class="sidebar-link">数据倾斜：内存不均</a></li><li class="sidebar-sub-header level3"><a href="/pages/e0e5a1/#请求倾斜-热点数据" class="sidebar-link">请求倾斜：热点数据</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-5-读写分离" class="sidebar-link">7.5 读写分离</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-6-数据迁移" class="sidebar-link">7.6 数据迁移</a></li><li class="sidebar-sub-header level2"><a href="/pages/e0e5a1/#_7-7-集群-vs-单机" class="sidebar-link">7.7 集群 vs 单机</a></li></ul></li><li><a href="/pages/4ac27b/" class="sidebar-link">第09章-缓存设计与优化</a></li><li><a href="/pages/50c785/" class="sidebar-link">第10章-Cache Cloud</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Elastic-Stack</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/database/#数据库" data-v-06225672>数据库</a></li><li data-v-06225672><a href="/database/#Redis从入门到高可用" data-v-06225672>Redis从入门到高可用</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/codeashen" target="_blank" title="作者" class="beLink" data-v-06225672>CodeAshen</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-02-10</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">第08章-Redis Cluster<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="一、呼唤集群"><a href="#一、呼唤集群" class="header-anchor">#</a> 一、呼唤集群</h1> <ol><li>并发量：单机 redis 可以承受 10 万的 QPS，如果并发量超过该数值，需要分布式集群</li> <li>数据量：数据量超过单机承载能力时，需要分布式集群</li> <li>网络流量：分担网卡压力，需要分布式集群</li></ol> <p>为了上述需求，redis 3.0 提供了 redis cluster 功能。</p> <h1 id="二、数据分布"><a href="#二、数据分布" class="header-anchor">#</a> 二、数据分布</h1> <h2 id="_2-1-数据分区方式"><a href="#_2-1-数据分区方式" class="header-anchor">#</a> 2.1 数据分区方式</h2> <p><img src="https://z3.ax1x.com/2021/06/08/2r2Gss.png" alt="image-20210608180609901"></p> <p>分布式数据库需要数据分区，分区要使用一定的规则，例如有顺序分区和哈希分区。</p> <p><img src="https://z3.ax1x.com/2021/06/08/2r2sy9.png" alt="image-20210608180746018"></p> <table><thead><tr><th style="text-align:center;">分布方式</th> <th style="text-align:center;">特点</th> <th style="text-align:center;">典型产品</th></tr></thead> <tbody><tr><td style="text-align:center;">哈希分区</td> <td style="text-align:center;">数据分散度高<br>键值分布业务无关<br>无法顺序访问<br>支持批量操作</td> <td style="text-align:center;">一致性哈希 Memcache<br>Redis Cluster<br>其他缓存产品</td></tr> <tr><td style="text-align:center;">顺序分区</td> <td style="text-align:center;">数据分散度易倾斜<br>键值业务相关<br>可顺序访问<br>支持批量操作</td> <td style="text-align:center;">GigTable<br>Hbase</td></tr></tbody></table> <p>哈希分区的几种方案：</p> <ul><li>节点取余分区</li> <li>一致性哈希分区</li> <li>虚拟槽分区（redis cluster 采用方式）</li></ul> <h2 id="_2-2-节点取余分区"><a href="#_2-2-节点取余分区" class="header-anchor">#</a> 2.2 节点取余分区</h2> <p>节点取余分区：<code>hash(key) % nodes</code>，但是添加节点后，数据分区需要偏移，影响很多数据。</p> <p><img src="https://z3.ax1x.com/2021/06/08/2rfzlD.png" alt="image-20210608181708138"></p> <ul><li>客户端分片：哈希 + 取余</li> <li>节点伸缩：数据节点关系变化，导致数据迁移</li> <li>迁移数量和添加节点数量有关：建议翻倍扩容</li></ul> <h2 id="_2-3-一致性哈希分区"><a href="#_2-3-一致性哈希分区" class="header-anchor">#</a> 2.3 一致性哈希分区</h2> <p><img src="https://z3.ax1x.com/2021/06/08/2r4ZU1.png" alt="image-20210608182231911"></p> <ul><li>客户端分片：哈希 + 顺时针（优化取余）</li> <li>节点伸缩：只影响邻近节点，但是还是有数据迁移</li> <li>翻倍伸缩：保证最小迁移数据和负载均衡</li></ul> <p>例如在 node1 和 node2 之间插入节点 node5，则只影响 node2上 的数据，别的节点数据不受影响。</p> <p><img src="https://z3.ax1x.com/2021/06/08/2r5SZd.png" alt="image-20210608182704133"></p> <h2 id="_2-4-虚拟槽分区"><a href="#_2-4-虚拟槽分区" class="header-anchor">#</a> 2.4 虚拟槽分区</h2> <ul><li>预设虚拟槽：每个槽映射一个数据子集，一般比节点数大</li> <li>良好的哈希函数：例如 CRC16</li> <li>服务端管理节点、槽、数据：例如 Redis Cluster</li></ul> <p><img src="https://z3.ax1x.com/2021/06/08/2r5ceH.png" alt="image-20210608182858454"></p> <p>数据 key 经过 hash 之后，对节点槽上限取余，结果落到哪个槽，数据就在对应的节点上</p> <h1 id="三、搭建集群"><a href="#三、搭建集群" class="header-anchor">#</a> 三、搭建集群</h1> <h2 id="_3-1-基本架构"><a href="#_3-1-基本架构" class="header-anchor">#</a> 3.1 基本架构</h2> <h3 id="单体架构"><a href="#单体架构" class="header-anchor">#</a> 单体架构</h3> <p><img src="https://z3.ax1x.com/2021/06/09/2yFfiR.png" alt="image-20210609100322478"></p> <ul><li>一个 redis 实例负责读写</li> <li>客户端连接这个单点</li></ul> <h3 id="分布式架构"><a href="#分布式架构" class="header-anchor">#</a> 分布式架构</h3> <p><img src="https://z3.ax1x.com/2021/06/09/2yeISA.png" alt="image-20210609102927474"></p> <ul><li>服务端有很多个节点，每个节点都负责去读也负责去写</li> <li>节点之间是彼此通信的，内部使用 Gossip 协议</li></ul> <h3 id="redis-cluster架构"><a href="#redis-cluster架构" class="header-anchor">#</a> Redis Cluster架构</h3> <ul><li>节点：集群中的 redis 节点</li> <li>meet：节点之间通信操作</li> <li>指派槽：每个节点都指派对应的槽，用来判断数据是否在该节点指派槽内</li> <li>复制：为了保证高可用，每个主节点都有一个从节点（内部监控不依赖于 sentinel）</li></ul> <p><strong>(1) 节点</strong></p> <p><img src="https://z3.ax1x.com/2021/06/09/2ym6pj.png" alt="image-20210609103135805"></p> <p>在 redis cluster 中有一个配置 <code>cluster-enabled: yes</code>，配置为 yes 表示以集群模式启动</p> <p><strong>(2) meet</strong></p> <p><img src="https://z3.ax1x.com/2021/06/09/2ym2Xq.png" alt="image-20210609103155317"></p> <p>节点之间通过 meet 操作，互相交换信息。在此基础上，知道哪些节点负责哪些槽。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2ymfBV.png" alt="image-20210609103224950"></p> <p>所有节点共享信息。</p> <p><strong>(3) 指派槽</strong></p> <p>如图，假设现在 redis cluster 总共有 16384 个槽，为了达到负载均衡的效果，为每个节点指派指定的槽。当命令的 key 到达某节点后，会根据 <code>hash(key) % 16384</code> 的计算结果，判断数据是否落在自己的指派槽范围内。如果在就返回结果，不在的话返回对应的节点，因为每个节点都知道每个节点个指派槽的关系。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2ymINF.png" alt="image-20210609103310911"></p> <p>对于客户端来说，只需要计算一个key，算出其对应的槽。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2ymzND.png" alt="image-20210609103439215"></p> <p><strong>(4) 复制</strong></p> <p>Redis Cluster 特性</p> <ul><li>复制：集群是有主从复制的，每个主节点都有一个从节点</li> <li>高可用：每个主节点故障，从节点都可以晋升，从而实现高可用</li> <li>分片：数据是分片的，由多个主节点进行读写</li></ul> <h2 id="_3-3-搭建集群-原生命令安装"><a href="#_3-3-搭建集群-原生命令安装" class="header-anchor">#</a> 3.3 搭建集群（原生命令安装）</h2> <ol><li><p>配置开启节点：加入 redis cluster 配置</p> <p>节点配置</p> <p><img src="https://z3.ax1x.com/2021/06/09/2yDrUU.png" alt="image-20210609114029307"></p> <blockquote><p>主要配置说明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cluster-enabled yes                # 集群模式启动
cluster-node-timeout 15000         # 节点超时时间（毫秒）
cluster-config-file &quot;nodes.conf&quot;   # 集群节点的配置
cluster-require-full-coverage yes  # 集群是否需要要求所有节点都正常，一般配置no
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></blockquote> <p>启动多个节点</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-server redis-7000.conf 
redis-server redis-7001.conf 
redis-server redis-7002.conf 
redis-server redis-7003.conf 
redis-server redis-7004.conf 
redis-server redis-7005.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>meet 操作：实现节点间的通信</p> <p>执行 meet 命令，<code>cluster meet ip port</code>，让节点之间建立通信关系</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">7001</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">7002</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">7003</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">7004</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">7005</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上述命令，在 7000 端口的节点 meet 了 7001~7005 节点，根据 Gossip 协议，他们会互相交换信息，从而互相全部连通。</p></li> <li><p>分配指派槽：确定数据访问关系</p> <p>通过以下命令分配槽，<code>cluster addslots slot [slot...]</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> cluster addslots <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">5461</span><span class="token punctuation">}</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7001</span> cluster addslots <span class="token punctuation">{</span><span class="token number">5462</span><span class="token punctuation">..</span><span class="token number">10922</span><span class="token punctuation">}</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7002</span> cluster addslots <span class="token punctuation">{</span><span class="token number">10923</span><span class="token punctuation">..</span>.16383<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>分配槽命令是一个一个分配的，可以使用 shell 帮助分配，以下脚本 addslots.sh</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">start</span><span class="token operator">=</span><span class="token variable">$1</span>   <span class="token comment"># 参数1：起始槽</span>
<span class="token assign-left variable">end</span><span class="token operator">=</span><span class="token variable">$2</span>     <span class="token comment"># 参数2：终止槽</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token variable">$3</span>    <span class="token comment"># 参数2：端口</span>

<span class="token comment"># 循环将槽分配给指定端口的 redis 节点</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">slot</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> $<span class="token punctuation">{</span>start<span class="token punctuation">}</span> $<span class="token punctuation">{</span>end<span class="token punctuation">}</span><span class="token variable">`</span></span>
<span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;slot:<span class="token variable">${slot}</span>&quot;</span>
    redis-cli <span class="token parameter variable">-p</span> <span class="token variable">${port}</span> cluster addslots <span class="token variable">${slot}</span>
<span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>执行脚本，给 7000、7001、7002 节点分配槽</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sh</span> addslots.sh <span class="token number">0</span> <span class="token number">5461</span> <span class="token number">7000</span>
<span class="token function">sh</span> addslots.sh <span class="token number">5462</span> <span class="token number">10922</span> <span class="token number">7001</span>
<span class="token function">sh</span> addslots.sh <span class="token number">10923</span> <span class="token number">16383</span> <span class="token number">7002</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></blockquote></li> <li><p>设置主从：有主从关系才能实现故障的自动转移</p> <p>通过以下命令，设置集群主从关系，<code>cluster replicate node-id</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7003</span> cluster replicate <span class="token variable">${node-id-7000}</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7004</span> cluster replicate <span class="token variable">${node-id-7001}</span> 
redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7005</span> cluster replicate <span class="token variable">${node-id-7002}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上述命令中，让 7003 去复制 7000，让 7004 去复制 7001，让 7005 去复制 7002</p></li></ol> <p>下面介绍一些集群命令</p> <ul><li><code>cluster nodes</code>：查看集群节点信息</li> <li><code>cluster info</code>：查看集群信息</li> <li><code>cluster solts</code>：查看集群槽的分配情况</li></ul> <h2 id="_3-4-搭建集群-官方工具-redis-trib"><a href="#_3-4-搭建集群-官方工具-redis-trib" class="header-anchor">#</a> 3.4 搭建集群（官方工具 redis-trib）</h2> <p>原生安装方式很麻烦，生产环境一般不使用。官方提供了 ruby 的安装脚本，相比原生安装方式方便很多。</p> <h3 id="ruby-环境准备"><a href="#ruby-环境准备" class="header-anchor">#</a> ruby 环境准备</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 下载 ruby</span>
<span class="token function">wget</span> https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz

<span class="token comment"># 安装 ruby </span>
tar-xvf ruby-2.3.1.tar.gz 
./configure <span class="token parameter variable">-prefix</span><span class="token operator">=</span>/usr/local/ruby 
<span class="token function">make</span> 
<span class="token function">make</span> <span class="token function">install</span> 
<span class="token builtin class-name">cd</span> /usr/local/ruby 
<span class="token function">cp</span> bin/ruby /usr/local/bin
<span class="token function">cp</span> bin/gem /usr/local/bin

<span class="token comment"># 安装 rubygem redis</span>
<span class="token function">wget</span> http://rubygems.org/downloads/redis-3.3.0.gem 
gem <span class="token function">install</span> <span class="token parameter variable">-l</span> redis-3.3.0.gem 
gem list <span class="token parameter variable">--check</span> redis gem

<span class="token comment"># 安装 redis-trib.rb</span>
<span class="token function">cp</span> <span class="token variable">${REDIS_HOME}</span>/src/redis-trib.rb /usr/local/bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="搭建集群"><a href="#搭建集群" class="header-anchor">#</a> 搭建集群</h3> <ol><li><p>启动节点</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-server redis-8000.conf 
redis-server redis-8001.conf 
redis-server redis-8002.conf 
redis-server redis-8003.conf 
redis-server redis-8004.conf 
redis-server redis-8005.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>一键搭建集群</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 1 表示主节点的从节点个数，前三个 {ip:port} 表示主节点，后三个表示对应的从节点</span>
./redis-trib.rb create <span class="token parameter variable">--replicas</span> <span class="token number">1</span> <span class="token number">127.0</span>.0.1:8000 <span class="token number">127.0</span>.0.1:8001 <span class="token number">127.0</span>.0.1:8002 <span class="token number">127.0</span>.0.1:8003 <span class="token number">127.0</span>.0.1:8004 <span class="token number">127.0</span>.0.1:8005
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>ruby 脚本命令解释：<a href="https://www.cnblogs.com/ivictor/p/9768010.html" target="_blank" rel="noopener noreferrer">redis-trib.rb命令详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote></li></ol> <h2 id="_3-5-总结"><a href="#_3-5-总结" class="header-anchor">#</a> 3.5 总结</h2> <ol><li>原生命令安装
<ul><li>理解 Redis Cluster 架构。</li> <li>生产环境不使用。</li></ul></li> <li>官方工具安装
<ul><li>高效、准确。</li> <li>生产环境可以使用。</li></ul></li> <li>其他
<ul><li>可视化部署</li></ul></li></ol> <h1 id="四、集群伸缩"><a href="#四、集群伸缩" class="header-anchor">#</a> 四、集群伸缩</h1> <h2 id="_4-1-伸缩原理"><a href="#_4-1-伸缩原理" class="header-anchor">#</a> 4.1 伸缩原理</h2> <p><img src="https://z3.ax1x.com/2021/06/09/26DIk8.png" alt="image-20210609153637202"></p> <p>集群伸缩就是有节点加入集群或从集群中下线。</p> <p><strong>集群伸缩 = 槽和数据在节点之间的移动</strong>，如下图，是一个扩容集群的示意图</p> <p><img src="https://z3.ax1x.com/2021/06/09/26rDun.png" alt="image-20210609153716625"></p> <h2 id="_4-2-扩容集群"><a href="#_4-2-扩容集群" class="header-anchor">#</a> 4.2 扩容集群</h2> <p>扩容集群的步骤：</p> <ol><li>准备新节点</li> <li>加入集群</li> <li>迁移槽和数据</li></ol> <h3 id="准备新节点"><a href="#准备新节点" class="header-anchor">#</a> 准备新节点</h3> <p>新节点特点：</p> <ul><li>集群模式</li> <li>配置和其他节点统一</li> <li>启动后是孤儿节点</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-server conf/redis-6385.conf 
redis-server conf/redis-6386.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://z3.ax1x.com/2021/06/09/26s324.png" alt="image-20210609154049422"></p> <h3 id="加入集群"><a href="#加入集群" class="header-anchor">#</a> 加入集群</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">6385</span> 
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster meet <span class="token number">127.0</span>.0.1 <span class="token number">6386</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://z3.ax1x.com/2021/06/09/26yVJO.png" alt="image-20210609154226931"></p> <p>加入集群的作用：</p> <ul><li>为它迁移槽和数据实现 <em>扩容</em></li> <li>作为从节点负责 <em>故障转移</em></li></ul> <p>以上的原生 redis cluster 方式加入集群，下面是 redis-trib.rb 方式加入集群：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>redis-trib.rb add-node new_host:new_port existing_host:existing_port <span class="token parameter variable">--slave</span> --master-id <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span> 
redis-trib.rb add-node <span class="token number">127.0</span>.0.1:6385 <span class="token number">127.0</span>.0.1:6379 
<span class="token comment"># 建议使用 redis-trib.rb 能够避免新节点已经加入了其他集群，造成故障。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="迁移槽和数据"><a href="#迁移槽和数据" class="header-anchor">#</a> 迁移槽和数据</h3> <p>步骤：</p> <ol><li><p>槽迁移计划</p> <p><img src="https://z3.ax1x.com/2021/06/09/262zrQ.png" alt="image-20210609155228536"></p></li> <li><p>迁移数据</p> <p>迁移数据步骤：</p> <p><img src="https://z3.ax1x.com/2021/06/09/26WU6U.png" alt="image-20210609155955050"></p> <ol><li>对目标节点发送：<code>cluster setslot {slot} importing {sourceNodeld}</code> 命令，让目标节点准备导入槽的数据。</li> <li>对源节点发送：<code>cluster setslot {slot} migrating {targetNodeld}</code> 命令，让源节点准备迁出槽的数据。</li> <li>源节点循环执行 <code>cluster getkeysinslot {slot} {count}</code> 命令，每次获取 count 个属于槽的健。</li> <li>在源节点上执行 <code>migrate {targetIp} {targetPort} key 0 {timeout}</code> 命令把指定 key 迁移。</li> <li>重复执行步骤 3~4 直到槽下所有的键数据迁移到目标节点。</li> <li>向集群内所有主节点发送 <code>cluster setslot {slot} node {targetNodeld}</code> 命令，通知槽分配给目标节点。</li></ol> <p>迁移数据伪代码：</p> <p><img src="https://z3.ax1x.com/2021/06/09/26hJMT.png" alt="image-20210609160749006"></p> <p>redis 提供了 <code>pipeline migrate</code> 来批量迁移数据，此外还有 redis-trib.rb 方式。</p></li> <li><p>添加从节点</p></li></ol> <h2 id="_4-3-缩容集群"><a href="#_4-3-缩容集群" class="header-anchor">#</a> 4.3 缩容集群</h2> <p>缩容集群对应以下步骤：</p> <ol><li>下线迁移槽</li> <li>忘记节点</li> <li>关闭节点</li></ol> <p><img src="https://z3.ax1x.com/2021/06/09/26o2ct.png" alt="image-20210609161947570"></p> <h3 id="下线槽"><a href="#下线槽" class="header-anchor">#</a> 下线槽</h3> <p><img src="https://z3.ax1x.com/2021/06/09/26TVHO.png" alt="image-20210609162058403"></p> <h3 id="忘记节点"><a href="#忘记节点" class="header-anchor">#</a> 忘记节点</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>redis-cli&gt; cluster forget {downNodeId}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://z3.ax1x.com/2021/06/09/26TGb8.png" alt="image-20210609162148714"></p> <p>如果需要忘记一个节点，需要对集群中其他的所有节点执行忘记命令，否则经过后效时间后，集群节点间的通信还会重新扩散该节点信息。</p> <h1 id="五、客户端路由"><a href="#五、客户端路由" class="header-anchor">#</a> 五、客户端路由</h1> <p>Redis Cluster 的客户端使用不同于单机和 sentinel 模式，需要使用其他的方式进行连接。</p> <h2 id="_5-1-moved重定向"><a href="#_5-1-moved重定向" class="header-anchor">#</a> 5.1 moved重定向</h2> <p>moved 重定向发生在命令 key 和连接的节点槽不匹配时。</p> <p>下图表示客户端向集群发送命令过程，其中第 4 步重定向发送命令需要客户端自己编码实现。</p> <p><img src="https://z3.ax1x.com/2021/06/09/26bGb6.png" alt="image-20210609163150290"></p> <p>槽命中：直接返回</p> <p><img src="https://z3.ax1x.com/2021/06/09/26bhxs.png" alt="image-20210609163320828"></p> <p>槽不命中：moved 异常</p> <p><img src="https://z3.ax1x.com/2021/06/09/26OVbt.png" alt="image-20210609164449354"></p> <p>演示：</p> <p><img src="https://z3.ax1x.com/2021/06/09/26OtaV.png" alt="image-20210609164608186"></p> <p>第一次 redis 客户端连接添加了 <code>-c</code> 参数，表示集群方式连接，可以槽不匹配时会自动重定向；第二次没有以集群方式连接，槽不匹配会抛出 moved 异常。</p> <h2 id="_5-2-ask重定向"><a href="#_5-2-ask重定向" class="header-anchor">#</a> 5.2 ask重定向</h2> <p>如果集群发生了扩容或缩容，源节点的 solt 迁移到目标节点，此过程中访问就会有问题。Redis Cluster 考虑到这个问题，有 ask 重定向。</p> <p><img src="https://z3.ax1x.com/2021/06/09/26joUP.png" alt="image-20210609165650494"></p> <p>ask 重定向过程：</p> <p><img src="https://z3.ax1x.com/2021/06/09/26xCdI.png" alt="image-20210609170208014"></p> <p>moved重定向和ask重定向：</p> <ul><li>两者都是客户单重定向</li> <li>moved：槽已经确定迁移</li> <li>ask：槽还在迁移中</li></ul> <p>两者都对客户端提出了挑战，命令和槽的匹配性，重定向过程会有性能问题。</p> <h2 id="_5-3-smart-客户端"><a href="#_5-3-smart-客户端" class="header-anchor">#</a> 5.3 smart 客户端</h2> <h3 id="smart-客户端原理"><a href="#smart-客户端原理" class="header-anchor">#</a> smart 客户端原理</h3> <p>smart客户端的目标是追求性能</p> <ol><li>从集群中选一个可运行节点，使用 cluster slots 初始化槽和节点映射。</li> <li>将 cluster slots 的结果映射到本地，为每个节点创建 JedisPool。</li> <li>准备执行命令。</li></ol> <p>执行命令简单流程如下</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cScdA.png" alt="image-20210609171939509"></p> <h3 id="smart-客户端使用-jediscluster"><a href="#smart-客户端使用-jediscluster" class="header-anchor">#</a> smart 客户端使用：JedisCluster</h3> <p><strong>简单使用：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 定义集群节点集合</span>
<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span> nodeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostAndPort</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST1</span><span class="token punctuation">,</span> <span class="token constant">PORT1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST2</span><span class="token punctuation">,</span> <span class="token constant">PORT2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST3</span><span class="token punctuation">,</span> <span class="token constant">PORT3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST4</span><span class="token punctuation">,</span> <span class="token constant">PORT4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST5</span><span class="token punctuation">,</span> <span class="token constant">PORT5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
nodeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token constant">HOST6</span><span class="token punctuation">,</span> <span class="token constant">PORT6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 创建 JedisCluster 对象</span>
<span class="token class-name">JedisCluster</span> redisCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>nodeList<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> poolConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 执行命令</span>
redisCluster<span class="token punctuation">.</span>command<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>使用技巧：</strong></p> <ol><li>单例：内置了所有节点的连接池</li> <li>无需手动借还连接池</li> <li>合理设置 commons-pool</li></ol> <p><strong>多节点命令实现：</strong></p> <p>有些命令需要跨节点，比如 scan</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 获取所有节点的 JeidsPool </span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JedisPool</span><span class="token punctuation">&gt;</span></span> jedisPoolMap <span class="token operator">=</span> jedisCluster<span class="token punctuation">.</span><span class="token function">getClusterNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">JedisPool</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> jedisPoolMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 获取每个节点的 Jedis 连接 </span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 只删除主节点数据 </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isMaster</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">continue</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">// finally close</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>批量操作优化：</strong></p> <p>使用 jedisCluster 完成批量操作，必须保证 mget、mset 的 key 在一个槽内，该条件非常苛刻。批量操作，有以下四种方案：</p> <ul><li><p>串行 mget</p> <p>串行执行单个命令</p> <p><img src="https://z3.ax1x.com/2021/06/09/2ciZ4A.png" alt="image-20210609174044483"></p></li> <li><p>串行 IO</p> <p>先把 key 在客户端进行分组，相同节点上槽的 key 分成一组，然后逐组 pipeline 请求集群中的节点</p> <p><img src="https://z3.ax1x.com/2021/06/09/2ci0DU.png" alt="image-20210609174206883"></p></li> <li><p>并行 IO</p> <p>并行 IO 就是在串行 IO 的基础上，key 分组后多线程并行请求后端节点</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cFSaQ.png" alt="image-20210609174614185"></p></li> <li><p>hash_tag</p> <p>将所有的 key 进行 tag 包装，让所有的 key 都落在一个节点，以后 mget 就只需要请求一个节点</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cFnIJ.png" alt="image-20210609174735252"></p></li></ul> <table><thead><tr><th>方案</th> <th>优点</th> <th>缺点</th> <th>网络IO</th></tr></thead> <tbody><tr><td>串行 mget</td> <td>编程简单<br>少量keys满足需求</td> <td>大量 keys 请求延迟严重</td> <td>O(keys)</td></tr> <tr><td>串行 IO</td> <td>编程简单<br>少量节点满足需求</td> <td>大量 node 时延迟严重</td> <td>O(nodes)</td></tr> <tr><td>并行 IO</td> <td>利用并行特性<br>延迟取决于最慢的节点</td> <td>编程复杂<br>超时定位问题难</td> <td>O(max_slow(node))</td></tr> <tr><td>hash_tag</td> <td>性能最高</td> <td>读写增加 tag 维护成本<br>tag 分布易出现数据倾斜</td> <td>O(1)</td></tr></tbody></table> <h1 id="六、故障转移"><a href="#六、故障转移" class="header-anchor">#</a> 六、故障转移</h1> <p>Redis Cluster 中并没有使用 Sentinel 进行监控，因为 Redis Cluster 自身实现了高可用，如果当前节点故障，其他节点可以监控到，实现故障转移。</p> <h2 id="_6-1-故障发现"><a href="#_6-1-故障发现" class="header-anchor">#</a> 6.1 故障发现</h2> <p>Redis Cluster 中故障发现原理：</p> <ul><li>通过节点间的 ping/pong 消息实现故障发现：不需要 sentinel</li> <li>也分为主观下线和客观下线</li></ul> <h3 id="主观下线"><a href="#主观下线" class="header-anchor">#</a> 主观下线</h3> <p>定义：某个节点认为另一个节点不可用，“偏见”</p> <p>主观下线流程：</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cA22n.png" alt="image-20210609175847985"></p> <h3 id="客观下线"><a href="#客观下线" class="header-anchor">#</a> 客观下线</h3> <p>定义：当半数以上持有槽的主节点都标记某节点主观下线</p> <p>客观下线逻辑流程：</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cECPH.png" alt="image-20210609180039669"></p> <p>尝试客观下线流程：</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cEGLV.png" alt="image-20210609180307754"></p> <p>客观下线后，进行以下两个工作</p> <ul><li>通知集群内所有节点标记故障节点为客观下线</li> <li>通知故障节点的从节点触发故障转移流程</li></ul> <h2 id="_6-2-故障恢复"><a href="#_6-2-故障恢复" class="header-anchor">#</a> 6.2 故障恢复</h2> <p>客观下线后通知到从节点，从节点就会准备开始做故障恢复，从而保证整个集群的高可用。其中包含以下 4 个过程：</p> <ol><li>资格检查</li> <li>准备选举时间</li> <li>选举投票</li> <li>替换主节点</li></ol> <h3 id="资格检查"><a href="#资格检查" class="header-anchor">#</a> 资格检查</h3> <ul><li>每个从节点检查与故障主节点的断线时间。</li> <li>超过 <code>cluster-node-timeout * cluster-slave-validity-factor</code> 的计算结果，取消资格。</li> <li><code>cluster-slave-validity-factor</code>：默认是 10</li></ul> <h3 id="准备选举时间"><a href="#准备选举时间" class="header-anchor">#</a> 准备选举时间</h3> <p>当从节点符合故障转移的资格之后，需要更新触发故障选举的时间，只有达到该时间才会触发后续的流程。这一步是为了保证偏移量大的从节点有更小的延迟，从而达到所谓的选举时间。其实是为了保证数据一致性更高，因为此时主节点故障，只有偏移量最大的从节点数据数据更完整，设置更短的选举时间，让它更快的参与选举。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cVRBV.png" alt="image-20210609181022697"></p> <h3 id="选举投票"><a href="#选举投票" class="header-anchor">#</a> 选举投票</h3> <p>从节点达到选举时间后，会让主节点对该从节点进行投票。先进入选举的节点更容易得到更多的票数，当票数超过主节点个数的 <code>1/2 + 1</code> 票后，该节点可以替换主节点。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cZIVf.png" alt="image-20210609181606375"></p> <h3 id="替换主节点"><a href="#替换主节点" class="header-anchor">#</a> 替换主节点</h3> <ol><li>当前从节点取消复制变为主节点。（<code>slaveof no one</code>）</li> <li>执行 <code>clusterDelSlot</code> 撤销故障主节点负责的槽，并执行 <code>clusterAddSlot</code> 把这些槽分配给自己。</li> <li>向集群广播自己的 pong 消息，表明已经替换了故障从节点。</li></ol> <h1 id="七、开发运维常见问题"><a href="#七、开发运维常见问题" class="header-anchor">#</a> 七、开发运维常见问题</h1> <h2 id="_7-1-集群完整性"><a href="#_7-1-集群完整性" class="header-anchor">#</a> 7.1 集群完整性</h2> <ul><li><p><code>cluster-require-full-coverage</code> 默认为 yes</p> <ul><li><p>集群中 16384 个槽全部可用：保证集群完整性</p></li> <li><p>节点故障或者正在故障转移：</p> <p><code>(error) CLUSTERDOWN The cluster is down</code></p></li></ul></li> <li><p>大多数业务无法容忍，<code>cluster-require-full-coverage</code> 建议设置为 no</p></li></ul> <blockquote><p><code>cluster-require-full-coverage</code> 如果设置为 yes，只有集群中所有节点都是在线状态，所有 16384 个槽都是成功分配的状态，才认为集群是完整的，集群才会对外提供服务。</p></blockquote> <h2 id="_7-2-带宽消耗"><a href="#_7-2-带宽消耗" class="header-anchor">#</a> 7.2 带宽消耗</h2> <p>Redis Cluster 节点之间会定期交换信息以及心跳检测。节点见进行 ping/pong 消息，官方建议集群节点个数不要超过 1000 个，否则会带来不容忽视的带宽消耗。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cny5T.png" alt="image-20210609183541474"></p> <p>带宽消耗体现在以下三个方面：</p> <ul><li>消息发送频率：节点发现与其它节点最后通信时间超过 <code>cluster-node-timeout / 2</code> 时会直接发送 ping 消息</li> <li>消息数据量：slots 槽数组（2KB 空间）和整个集群 1/10 的状态数据（10 个节点状态数据约 1KB)</li> <li>节点部署的机器规模：集群分布的机器越多且每台机器划分的节点数越均匀，则集群内整体的可用带宽越高。</li></ul> <p>优化：</p> <ul><li>避免“大”集群：避免多业务使用一个集群，大业务可以多集群。</li> <li>cluster-node-timeout：带宽和故障转移速度的均衡。</li> <li>尽量均匀分配到多机器上：保证高可用和带宽</li></ul> <h2 id="_7-3-pub-sub-广播"><a href="#_7-3-pub-sub-广播" class="header-anchor">#</a> 7.3 Pub/Sub 广播</h2> <p>集群中任意一个节点发布消息，消息会在集群中进行传播，即其他节点都会订阅到该消息，增加了带宽消耗。</p> <p><img src="https://z3.ax1x.com/2021/06/09/2cuGLR.png" alt="image-20210609184414156"></p> <p>问题：publish 在集群每个节点广播：加重带宽</p> <p>解决：如果需要发布订阅，单独“走”一套 Redis Sentinel</p> <h2 id="_7-4-数据倾斜"><a href="#_7-4-数据倾斜" class="header-anchor">#</a> 7.4 数据倾斜</h2> <h3 id="数据倾斜-内存不均"><a href="#数据倾斜-内存不均" class="header-anchor">#</a> 数据倾斜：内存不均</h3> <p><img src="https://z3.ax1x.com/2021/06/09/2cMhrj.png" alt="image-20210609190118320"></p> <p>造成数据倾斜的一些原因：</p> <ol><li>节点和槽分配不均
<ul><li><code>redis-trib.rb info ip:port</code>：查看节点、槽、键值分布</li> <li><code>redis-trib.rb rebalance ip:port</code>：进行均衡操作（谨慎使用）</li></ul></li> <li>不同槽对应键值数量差异较大
<ul><li>CRC16 正常情况下比较均匀</li> <li>可能存在 hash_tag</li> <li><code>cluster countkeysinslot {slot}</code>：获取槽对应键值个数</li></ul></li> <li>包含 bigkey
<ul><li>bigkey：例如大字符串、几百万的元素的 hash、set 等</li> <li>从节点执行：<code>redis-cli --bigkeys</code></li> <li>优化：优化数据结构</li></ul></li> <li>内存相关配置不一致
<ul><li><code>hash-max-ziplist-value</code>、<code>set-max-intset-entries</code> 等配置</li></ul></li></ol> <h3 id="请求倾斜-热点数据"><a href="#请求倾斜-热点数据" class="header-anchor">#</a> 请求倾斜：热点数据</h3> <p>热点 key：重要的 key 或者 bigkey</p> <p>优化：</p> <ul><li>避免 bigkey</li> <li>热键不要用 hash_tag</li> <li>当一致性不高时，可以用本地缓存 + MQ</li></ul> <h2 id="_7-5-读写分离"><a href="#_7-5-读写分离" class="header-anchor">#</a> 7.5 读写分离</h2> <p>只读连接：集群模式的从节点不接受任何读写请求。</p> <ul><li>重定向到负责槽的主节点</li> <li>readonly 命令可以读：连接级别命令（只在本次连接内有效）</li></ul> <p>Redis Cluster 的读写分离实现更加复杂</p> <ul><li>同样的问题：复制延迟、读取过期数据、从节点故障</li> <li>修改客户端：cluster slaves {nodeld}</li> <li>集群模式下不建议读写分离，可以扩大集群规模</li></ul> <h2 id="_7-6-数据迁移"><a href="#_7-6-数据迁移" class="header-anchor">#</a> 7.6 数据迁移</h2> <p>官方迁移工具：redis-trib.rb import</p> <ul><li>只能从单机迁移到集群</li> <li>不支持在线迁移：source 需要停写</li> <li>不支持断点续传</li> <li>单线程迁移：影响速度</li></ul> <p>有一些第三方的工具支持在线迁移数据：</p> <ul><li>唯品会：redis-migrate-tool</li> <li>豌豆荚：redis-port</li></ul> <h2 id="_7-7-集群-vs-单机"><a href="#_7-7-集群-vs-单机" class="header-anchor">#</a> 7.7 集群 vs 单机</h2> <p>集群有以下限制：</p> <ul><li>key 批量操作支持有限：例如 mget、mset 必须在一个 slot</li> <li>Key 事务和 Lua 支持有限：操作的 key 必须在一个节点</li> <li>key 是数据分区的最小粒度：不支持 bigkey 分区</li> <li>不支持多个数据库：集群模式下只有一个 db 0</li> <li>复制只支持一层：不支持树形复制结构</li></ul> <p>思考：分布式 Redis 不一定好</p> <ol><li>Redis Cluster：满足容量和性能的扩展性，很多业务“不需要”
<ul><li>大多数时客户端性能会“降低”</li> <li>命令无法跨节点使用：mget、keys、scan、flush、sinter等</li> <li>Lua 和事务无法跨节点使用</li> <li>客户端维护更复杂：SDK 和应用本身消耗（例如更多的连接池）</li></ul></li> <li>很多场景 Redis Sentinel 已经足够好</li></ol> <h1 id="八、总结"><a href="#八、总结" class="header-anchor">#</a> 八、总结</h1> <ul><li>Redis cluster 数据分区规则采用虚拟槽方式（16384 个槽），每个节点负责一部分槽和相关数据，实现数据和请求的负载均衡。</li> <li>搭建集群划分四个步骤：准备节点、节点握手、分配槽、复制。
<code>redis-trib.rb</code> 工具用于快速搭建集群。</li> <li>集群伸缩通过在节点之间移动槽和相关数据实现。
<ul><li>扩容时根据槽迁移计划把槽从源节点迁移到新节点。</li> <li>收缩时如果下线的节点有负责的槽需要迁移到其它节点，再通过 <code>cluster forget</code> 命令让集群内所有节点忘记被下线节点。</li></ul></li> <li>使用 smart 客户端操作集群达到通信效率最大化，客户端内部负责计算维护 <code>键 -&gt; 槽 -&gt; 节点</code> 的映射，用于快速定位到目标节点。</li> <li>集群自动故障转移过程分为故障发现和节点恢复。节点下线分为主观下线和客观下线，当超过半数主节点认为故障节点为主观下线时标记它为客观下线状态。从节点负责对客观下线的主节点触发故障恢复流程，保证集群的可用性。</li> <li>开发运维常见问题包括：超大规模集群带宽消耗，pub/sub 广播问题，集群倾斜问题，单机和集群对比等。</li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/codeashen/notes/edit/master/docs/03.数据库/20.Redis从入门到高可用/08.Redis Cluster.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/06/04, 12:34:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/21251e/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第07章-Redis Sentinel</div></a> <a href="/pages/4ac27b/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第09章-缓存设计与优化</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/21251e/" class="prev">第07章-Redis Sentinel</a></span> <span class="next"><a href="/pages/4ac27b/">第09章-缓存设计与优化</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/630854/"><div>
            第01章-RabbitMQ导学
            <!----></div></a> <span class="date">02-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/c2f425/"><div>
            第02章-入门RabbitMQ核心概念
            <!----></div></a> <span class="date">02-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b09a03/"><div>
            第03章-RabbitMQ高级特性
            <!----></div></a> <span class="date">02-10</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:codeashen@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/codeashen" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://space.bilibili.com/7403658/" title="BiliBili" target="_blank" class="iconfont icon-bilibili"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2023
    <span>CodeAshen | <a href="https://github.com/codeashen/notes/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.973ec296.js" defer></script><script src="/assets/js/2.6aaa6d1e.js" defer></script><script src="/assets/js/70.ad84b59a.js" defer></script>
  </body>
</html>
