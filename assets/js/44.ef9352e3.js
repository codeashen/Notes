(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{369:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"_3-1-动静分离"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-动静分离"}},[s._v("#")]),s._v(" 3.1 动静分离")]),s._v(" "),t("p",[s._v("通过中间件将动态请求和静态请求分离。")]),s._v(" "),t("p",[s._v("**好处：**分离资源，减少不必要的请求消耗，减少请求延时。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s3.ax1x.com/2021/01/05/skUq58.png",alt:"image-20210105142105753"}})]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" 127.0.0.1:8080")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("\tlocalhost")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /opt/app/code")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" ~ \\.jsp$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n\t\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://java_api")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n\t\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.htm index.htm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" ~ \\.(jpg|png|gif)$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    \texpires 1h； \n    \tgzip on； \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    \t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("h2",{attrs:{id:"_3-2-rewrite规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-rewrite规则"}},[s._v("#")]),s._v(" 3.2 Rewrite规则")]),s._v(" "),t("p",[t("strong",[s._v("rewrite介绍")])]),s._v(" "),t("p",[s._v("Nginx的rewrite可以实现url重写以及重定向，适用场景如下：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("URL访问跳转，支持开发设计")]),s._v(" "),t("p",[s._v("页面跳转、兼容性支持、展示效果等")])]),s._v(" "),t("li",[t("p",[s._v("SEO优化")])]),s._v(" "),t("li",[t("p",[s._v("维护")]),s._v(" "),t("p",[s._v("后台维护、流量转发等")])]),s._v(" "),t("li",[t("p",[s._v("安全")])])]),s._v(" "),t("p",[t("strong",[s._v("配置语法")])]),s._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Syntax")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t\trewrite regex replacement [flag];")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t—")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\tserver, location, if")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("如果指定的正则表达式与请求URI匹配，则URI将按照 "),t("em",[s._v("replacement")]),s._v(" 字符串中的指定进行更改。该 "),t("em",[s._v("rewrite")]),s._v(" 指令在其在配置文件中出现的顺序顺序地执行。可以使用标志终止指令的进一步处理。如果替换字符串以 "),t("em",[s._v("http://")]),s._v("，"),t("em",[s._v("https://")]),s._v(" 或 "),t("em",[s._v("$scheme")]),s._v(" 开头，则处理停止，并将重定向返回给客户端。")]),s._v(" "),t("p",[s._v("flag参数：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("flag可选值")]),s._v(" "),t("th",[s._v("含义")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("last")]),s._v(" "),t("td",[s._v("停止rewrite检测，rewrite后继续匹配location配置，相当于请求转发")])]),s._v(" "),t("tr",[t("td",[s._v("break")]),s._v(" "),t("td",[s._v("停止rewrite检测，rewrite后不再继续匹配location")])]),s._v(" "),t("tr",[t("td",[s._v("redirect")]),s._v(" "),t("td",[s._v("返回302临时重定向，地址栏会显示跳转后的地址（后续还是由服务端返回重定向信息）")])]),s._v(" "),t("tr",[t("td",[s._v("permanent")]),s._v(" "),t("td",[s._v("返回301永久重定向，地址栏会显示跳转后的地址（客户端保存重定向信息，不通过服务端直接重定向）")])])])]),s._v(" "),t("p",[t("strong",[s._v("Rewrite规则优先级")])]),s._v(" "),t("ol",[t("li",[s._v("执行server块的rewrite指令")]),s._v(" "),t("li",[s._v("执行location匹配")]),s._v(" "),t("li",[s._v("执行选定的location中的rewrite")])]),s._v(" "),t("h2",{attrs:{id:"_3-3-高级模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-高级模块"}},[s._v("#")]),s._v(" 3.3 高级模块")]),s._v(" "),t("h3",{attrs:{id:"_3-3-1-secure-link-module模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-secure-link-module模块"}},[s._v("#")]),s._v(" 3.3.1 secure_link_module模块")]),s._v(" "),t("p",[s._v("该模块用于检查请求的链接，限制未经授权的访问，保护资源。")]),s._v(" "),t("ul",[t("li",[s._v("制定并允许检查请求的链接的真实性以及保护资源免遭未经授权的访问")]),s._v(" "),t("li",[s._v("限制链接生效周期")])]),s._v(" "),t("p",[t("strong",[s._v("相关配置")])]),s._v(" "),t("p",[t("strong",[s._v("1、secure_link")])]),s._v(" "),t("p",[s._v("定义一个带有变量的字符串，从中将提取链接的校验和值和过期时间。")]),s._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Syntax")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t\tsecure_link expression;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t—")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\thttp, server, location")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("2、secure_link_md5")])]),s._v(" "),t("p",[s._v("定义一个表达式，将为其计算MD5哈希值，并将其与请求中传递的值进行比较。")]),s._v(" "),t("p",[s._v("表达式应包含链接（资源）的安全部分和秘密成分。如果链接的生存期有限，则表达式还应包含*$secure_link_expires*。")]),s._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Syntax")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t\tsecure_link_md5 expression;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Default")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\t—")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("\thttp, server, location")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("strong",[s._v("验证图示：")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s3.ax1x.com/2021/01/05/skUOPS.png",alt:"image-20210105160406648"}})]),s._v(" "),t("p",[s._v("返回给客户端的下载连接：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://s3.ax1x.com/2021/01/05/skUX8g.png",alt:"image-20210105160520391"}})]),s._v(" "),t("p",[s._v("客户端使用下载连接发起下载请求后，nginx会进行加密验证和过期验证，校验md5参数的加密信息，加密信息可基于IP等信息生成，校验expires指定的过期时间。")]),s._v(" "),t("p",[t("strong",[s._v("配置示例")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('location / {\n\t# 提取链接中的加密串和过期时间\n\tsecure_link $arg_nd5,$arg_expires; \n\t# 使用按规则加入字符串"lucifer"进行加密，与上面取到的参数对比，看是否匹配\n\tsecure_link_md5 "$secure_link_expires$uri lucifer";\n\t\n\t# 变量$secure_link用于存放验证结果，根据结果执行以下逻辑\n\tif ($secure_link="") { \n\t\treturn 403；\n    }\n    \n    if ($secure_link="0") { \n\t\treturn 410；\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"_3-3-2-ngx-http-geoip-module模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-ngx-http-geoip-module模块"}},[s._v("#")]),s._v(" 3.3.2 ngx_http_geoip_module模块")]),s._v(" "),t("p",[s._v("基于IP地址匹配MaxMind GeoIP二进制文件，读取IP所在地域信息。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装模块")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx-module-geoip\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("适用场景：")]),s._v(" "),t("ul",[t("li",[s._v("区别国内外作HTTP访问规则")]),s._v(" "),t("li",[s._v("区别国内城市地域作HTTP访问规则")])]),s._v(" "),t("p",[s._v("相关变量")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$geoip_country_name\t\t国家名\n$geoip_country_code\t\t国家代码（CN,US）\n$geoip_city\t\t\t\t城市名\n......\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("配置示例")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 国家码不是中国就返回403")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" ("),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$geoip_country_code")]),s._v(" != CN)")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("403")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /usr/share/nginx/html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /my_ip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" text/plain")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出ip、国家名、国家码、城市名")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$remote_addr")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$geoip_country_name")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$geoip_country_code")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$geoip_city")]),s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h2",{attrs:{id:"_3-4-基于nginx的https服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-基于nginx的https服务"}},[s._v("#")]),s._v(" 3.4 基于Nginx的HTTPS服务")]),s._v(" "),t("h3",{attrs:{id:"_3-4-1-https介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-https介绍"}},[s._v("#")]),s._v(" 3.4.1 HTTPS介绍")]),s._v(" "),t("p",[s._v("为什么需要HTTPS?因为HTTP不安全？")]),s._v(" "),t("ol",[t("li",[s._v("传输数据被中间人盗用、信息泄露")]),s._v(" "),t("li",[s._v("数据内容劫持、篡改")])]),s._v(" "),t("p",[s._v("HTTPS协议的实现：对传输内容进行加密以及身份验证")]),s._v(" "),t("p",[s._v("对称加密和非对称加密")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/08/03/fi9dUS.png",alt:"对称加密"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/08/03/fi9WUU.png",alt:"非对称加密"}})]),s._v(" "),t("p",[s._v("程参考："),t("a",{attrs:{href:"https://www.jianshu.com/p/14cd2c9d2cd2",target:"_blank",rel:"noopener noreferrer"}},[s._v("Https原理及流程"),t("OutboundLink")],1)]),s._v(" "),t("h3",{attrs:{id:"_3-4-2-生成证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-2-生成证书"}},[s._v("#")]),s._v(" 3.4.2 生成证书")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("openssl")]),s._v(" 生成证书请求文件，交给签名机构进行证书签名，这里我们本地签名。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" ssl_key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ssl_key\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用idea算法，生成mykey.key文件，加密位数1024，执行后需要指定密码，记住这个密码")]),s._v("\nopenssl genrsa "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-idea")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" mykey.key "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成证书签名请求文件，执行期间需要填写一些信息")]),s._v("\nopenssl req "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-key")]),s._v(" mykey.key "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" mykey.csr\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 至此会生成两个文件，mykey.key和key.csr，发给签名机构进行签名即可")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 本地调试，自己进行签名，生成签名文件mykey.crt")]),s._v("\nopenssl x509 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-req")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-days")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3650")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" mykey.csr "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-signkey")]),s._v(" mykey.key "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" mykey.crt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/08/03/fiZEgU.png",alt:"image-20210803153205366"}})]),s._v(" "),t("h3",{attrs:{id:"_3-4-3-nginx配置https"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-3-nginx配置https"}},[s._v("#")]),s._v(" 3.4.3 nginx配置HTTPS")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#HTTPS监听443端口")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" 10.60.131.23")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#开启https")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定签名文件和key文件位置")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate")]),s._v(" /etc/nginx/ssl_key/mykey.crt")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate_key")]),s._v(" /etc/nginx/ssl_key/mykey.key")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /opt/app/code")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("此时重启nginx，需要输入生成key文件时的密码，重启后就可以通过浏览器使用HTTPS协议请求nginx了。")]),s._v(" "),t("p",[s._v("如今苹果对安全要求越来越高，苹果要求的证书需要符合以下条件：")]),s._v(" "),t("ul",[t("li",[s._v("服务器所有的连接使用TLS1.2以上版本（openssl 1.0.2)")]),s._v(" "),t("li",[s._v("HTTPS证书必须使用SHA256以土哈希算法签名")]),s._v(" "),t("li",[s._v("HTTPS证书必须使用RSA2048位或ECC256位以上公钥算法d、使用前向加密技术")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看openssl版本")]),s._v("\nopenssl version\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看加密证书算法类型和加密位数")]),s._v("\nopenssl x509 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-noout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-text")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-in")]),s._v(" ./mykey.crt\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除原来crt文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" mykey.crt\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 直接通过key文件生成签名文件，符合苹果要求")]),s._v("\nopenssl req "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-days")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36500")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-x059")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-sha256")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-nodes")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-newkey")]),s._v(" rsa:2048 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-keyout")]),s._v(" mykey.key "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-out")]),s._v(" mykey_apple.crt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("h3",{attrs:{id:"_3-4-4-https服务优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-4-https服务优化"}},[s._v("#")]),s._v(" 3.4.4 HTTPS服务优化")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("激活keepalive长连接")])]),s._v(" "),t("li",[t("p",[s._v("设置ssl session缓存")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_cache")]),s._v("   shared:SSL:10m")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#配置10MB会话缓存，大约可缓存8000-10000个会话")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_timeout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10m")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#会话过期时间10min")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h2",{attrs:{id:"_3-5-nginx与lua开发"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-nginx与lua开发"}},[s._v("#")]),s._v(" 3.5 Nginx与Lua开发")]),s._v(" "),t("p",[s._v("Lua是一个简洁、轻量、可扩展的脚本语言。")]),s._v(" "),t("p",[t("strong",[s._v("Nginx+Lua优势")]),s._v("：充分的结合Nginx的并发处理epoll优势和Lua的轻量实现简单的功能切高并发的场景。")]),s._v(" "),t("h3",{attrs:{id:"_3-5-1-lua基础语法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-1-lua基础语法"}},[s._v("#")]),s._v(" 3.5.1 Lua基础语法")]),s._v(" "),t("p",[s._v("安装")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("yum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" lua\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("运行（分为命令行和脚本文件形式）")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" lua\nLua "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Copyright")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("C"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1994")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2008")]),s._v(" Lua"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" PUC"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("Rio\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello, world"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nHello"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" world\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# lua ./test.lua\nHello, world\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("基本语法：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("布尔型：只有 "),t("code",[s._v("nil")]),s._v(" 和 "),t("code",[s._v("false")]),s._v(" 是 "),t("code",[s._v("false")]),s._v("；"),t("code",[s._v("0")]),s._v(" 和空字符串等其他的都是 "),t("code",[s._v("true")])])]),s._v(" "),t("li",[t("p",[s._v("lua变量没有特殊说明的话都是全局变量")])]),s._v(" "),t("li",[t("p",[s._v("while循环语句")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nnum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" num\n    num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sum = "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("for循环")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[s._v("sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" i\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("if-else判断语句")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" age "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("and")]),s._v(" sex "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"male"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"大于40男人"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("elseif")]),s._v(" age "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("and")]),s._v(" sex "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"female"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 不等于用~=")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"非女人而且大于60"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" age "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" io"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- io库的分别从stdin和stdout读写的read和write函数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"You age is "')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("..")]),s._v("age"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 字符串拼接操作符 ..")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"_3-5-2-nginx-lua环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-2-nginx-lua环境"}},[s._v("#")]),s._v(" 3.5.2 Nginx+Lua环境")]),s._v(" "),t("p",[s._v("如果需要 Nginx 结合 Lua，需要在重新编译 Nginx，以支持 Lua 模块。")]),s._v(" "),t("ol",[t("li",[s._v("下载 LuaJIT，一个 lua 解析器")]),s._v(" "),t("li",[s._v("下载 nginx 对应的开发库和对应模块文件，ngx_devel_kit 和 lua-nginx-module")]),s._v(" "),t("li",[s._v("解压重新编译 Nginx")])]),s._v(" "),t("p",[s._v("具体编译步骤参考手记："),t("a",{attrs:{href:"https://www.imooc.com/article/19597",target:"_blank",rel:"noopener noreferrer"}},[t("strong",[s._v("Nginx编译安装Lua模块")]),t("OutboundLink")],1)]),s._v(" "),t("h3",{attrs:{id:"_3-5-3-nginx调用lua"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-3-nginx调用lua"}},[s._v("#")]),s._v(" 3.5.3 Nginx调用Lua")]),s._v(" "),t("p",[t("strong",[s._v("Nginx调用Lua模块指定")])]),s._v(" "),t("p",[s._v("Nginx的可插拔模块化加载执行，共11个处理阶段，每个阶段都可以调用对应的Lua模块指令，来实现对应的功能。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/08/03/fC2zkQ.png",alt:"image-20210803005300607"}})]),s._v(" "),t("blockquote",[t("p",[s._v("上述有"),t("code",[s._v("_file")]),s._v("结尾的表示执行lua脚本文件，没有的表示执行单挑lua指令")])]),s._v(" "),t("p",[t("strong",[s._v("Nginx调用Lua API接口")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://z3.ax1x.com/2021/08/03/fCRPlq.png",alt:"image-20210803005923585"}})]),s._v(" "),t("h3",{attrs:{id:"_3-5-4-nginx-lua示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-4-nginx-lua示例"}},[s._v("#")]),s._v(" 3.5.4 Nginx+Lua示例")]),s._v(" "),t("h4",{attrs:{id:"简单示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简单示例"}},[s._v("#")]),s._v(" 简单示例")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用content_by_lua指令处理响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# lua脚本调用ngx.say接口，输出"hello, lua"作为响应')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /hello")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ngx.say(\"hello, lua\")'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调用ngx.req.get_headers接口从请求头x_forwarded_for中获取客户端ip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 赋值给clientIP，再调用ngx.say接口输出响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /myip")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/plain'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'\n        clientIP = ngx.req.get_headers()["x_forwarded_for"]\n        ngx.say("IP:", clientIP)\n        \'')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("h4",{attrs:{id:"灰度发布示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#灰度发布示例"}},[s._v("#")]),s._v(" 灰度发布示例")]),s._v(" "),t("p",[s._v("Nginx配置：")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根配置，调用lua脚本接收请求处理响应")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default_type")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'text/html'")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("content_by_lua_file")]),s._v(" /opt/app/lua/dep.lua")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#指定lua脚本位置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正式环境，请求转发到 127.0.0.1:8080")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" @server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://127.0.0.1:8080")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 灰度环境，请求转发到 127.0.0.1:9090")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" @server_test")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" http://127.0.0.1:9090")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("Lua脚本内容：")]),s._v(" "),t("div",{staticClass:"language-lua line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-lua"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 根据优先级依次通过请求头，nginx变量remote_addr，获取clientIP")]),s._v("\nclientIP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_headers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"X-Real-IP"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" clientIP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    clientIP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_headers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"x_forwarded_for"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" clientIP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("nil")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    clientIP "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("var"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("remote_addr\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加载memcache库，实例化memcached对象")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" memcached "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" require "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resty.memcached"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" memc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memcached"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("new")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" memc "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to instantiate memc: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 连接memcache")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" ok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("connect")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11211")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" memc "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to connect memc: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 以clientIP为key，获取memcache中的value")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("local")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" flags"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("clientIP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nnginx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"value key: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" clientIP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" \n    ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("say")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"failed to get clientIP: "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 如果命中缓存并且值为1，说明在灰度白名单，访问灰度环境")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" res "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" \n    ngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@server_test"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 走nginx配置的 location @server_test")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 没有命中缓存，走正式环境")]),s._v("\nngx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"@server"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 走nginx配置的 location @server")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);