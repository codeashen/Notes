# 一、呼唤集群

1. 并发量：单机redis可以承受10万的QPS，如果并发量超过该数值，需要分布式集群
2. 数据量：数据量超过单机承载能力时，需要分布式集群
3. 网络流量：分担网卡压力，需要分布式集群

为了上述需求，redis 3.0提供了redis cluster功能。

# 二、数据分布

## 2.1 数据分区方式

![image-20210608180609901](https://z3.ax1x.com/2021/06/08/2r2Gss.png)

分布式数据库需要数据分区，分区要使用一定的规则，例如有顺序分区和哈希分区。

![image-20210608180746018](https://z3.ax1x.com/2021/06/08/2r2sy9.png)

| 分布方式 |                             特点                             |                       典型产品                        |
| :------: | :----------------------------------------------------------: | :---------------------------------------------------: |
| 哈希分区 | 数据分散度高<br/>键值分布业务无关<br/>无法顺序访问<br/>支持批量操作 | 一致性哈希Memcache<br/>Redis Cluster<br/>其他缓存产品 |
| 顺序分区 | 数据分散度易倾斜<br/>键值业务相关<br/>可顺序访问<br/>支持批量操作 |                  GigTable<br/>Hbase                   |

哈希分区的几种方案：

- 节点取余分区
- 一致性哈希分区
- 虚拟槽分区（redis cluster采用方式）

## 2.2 节点取余分区

节点取余分区：`hash(key) % nodes`，但是添加节点后，数据分区需要偏移，影响很多数据。

![image-20210608181708138](https://z3.ax1x.com/2021/06/08/2rfzlD.png)

- 客户端分片：哈希+取余
- 节点伸缩：数据节点关系变化，导致数据迁移
- 迁移数量和添加节点数量有关：建议翻倍扩容

## 2.3 一致性哈希分区

![image-20210608182231911](https://z3.ax1x.com/2021/06/08/2r4ZU1.png)

- 客户端分片：哈希+顺时针（优化取余）
- 节点伸缩：只影响邻近节点，但是还是有数据迁移
- 翻倍伸缩：保证最小迁移数据和负载均衡

例如在node1和node2之间插入节点node5，则只影响node2上的数据，别的节点数据不受影响。

![image-20210608182704133](https://z3.ax1x.com/2021/06/08/2r5SZd.png)

## 2.4 虚拟槽分区

- 预设虚拟槽：每个槽映射一个数据子集，一般比节点数大
- 良好的哈希函数：例如CRC16
- 服务端管理节点、槽、数据：例如Redis Cluster

![image-20210608182858454](https://z3.ax1x.com/2021/06/08/2r5ceH.png)

数据key经过hash之后，对节点槽上限取余，结果落到哪个槽，数据就在对应的节点上

# 三、搭建集群













集群伸缩

客户端路由

集群原理

开发运维常见问题

